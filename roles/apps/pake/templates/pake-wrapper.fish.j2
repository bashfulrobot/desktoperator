# Pake Docker wrapper functions
# Contains:
#   - generate-icon-set: Download/process icons, generate multi-sized variants, create role structure
#   - create-web-app: Build Pake desktop app using existing icons, complete Ansible scaffolding
#   - _create_ansible_tasks: (Internal) Generate Ansible tasks and handlers

# ------------------------------------------------------------------------------
# PUBLIC HELPER: generate-icon-set
# ------------------------------------------------------------------------------
# Downloads/processes icon and generates multi-sized variants
# Usage: generate-icon-set <icon_source> <name> [--output <path>] [--add-background]
#
# Arguments:
#   icon_source  - URL or local file path to icon (supports SVG, PNG, JPG)
#   name         - App name (used for output filenames)
#   --output     - Custom output directory (defaults to Ansible repo)
#   --add-background - Add gray rounded background
#
# Output locations:
#   Default: ~/dev/iac/desktoperator/roles/apps/{name}-pake/files/
#     Files: pake-{name}-icon.png, pake-{name}-icon-16.png, ...
#   With --output ~/Downloads: ~/Downloads/{name}/
#     Files: {name}.png, {name}-16.png, {name}-32.png, ...
#
# Examples:
#   generate-icon-set 'https://github.../logo.svg' github
#   generate-icon-set './logo.png' myapp --output ~/Downloads
#   generate-icon-set 'https://...' app --add-background
function generate-icon-set --description 'Download/process icon and generate multi-sized variants'
    # Parse arguments
    if test (count $argv) -lt 2
        echo "Usage: generate-icon-set <icon_source> <name> [--output <path>] [--add-background]"
        echo ""
        echo "Arguments:"
        echo "  icon_source  - URL or local file path (supports SVG, PNG, JPG)"
        echo "  name         - App name for output filenames"
        echo "  --output     - Custom output directory (default: Ansible repo)"
        echo "  --add-background - Add gray rounded background"
        echo ""
        echo "Examples:"
        echo "  generate-icon-set 'https://github.../logo.svg' github"
        echo "  generate-icon-set './my-icon.png' myapp --output ~/Downloads"
        echo "  generate-icon-set 'https://...' app --add-background"
        echo ""
        echo "Output (default): ~/dev/iac/desktoperator/roles/apps/<name>-pake/files/"
        echo "Output (custom):  <output-path>/<name>/"
        return 1
    end

    set -l icon_source $argv[1]
    set -l name $argv[2]
    set -l custom_output ""
    set -l add_background 0

    # Parse optional flags
    set -l i 3
    while test $i -le (count $argv)
        switch $argv[$i]
            case '--output'
                set i (math $i + 1)
                if test $i -le (count $argv)
                    set custom_output $argv[$i]
                end
            case '--add-background'
                set add_background 1
        end
        set i (math $i + 1)
    end

    # Determine output directory and filename patterns
    set -l output_dir ""
    set -l master_filename ""
    set -l size_filename_pattern ""
    set -l role_path ""

    if test -n "$custom_output"
        # Custom output (e.g., Downloads): use simple names
        set output_dir "$custom_output/$name"
        set master_filename "$name.png"
        set size_filename_pattern "$name"
    else
        # Default (Ansible repo): use pake-{name}-icon pattern and create full structure
        set role_path "$HOME/dev/iac/desktoperator/roles/apps/$name-pake"
        set output_dir "$role_path/files"
        set master_filename "pake-$name-icon.png"
        set size_filename_pattern "pake-$name-icon"

        # Create full Ansible role directory structure
        echo "Creating Ansible role structure..."
        mkdir -p "$role_path"/{files,tasks,handlers}
        echo "âœ“ Created role directories: files/, tasks/, handlers/"
    end

    # Create output directory (also works for custom paths)
    mkdir -p "$output_dir"
    set -l temp_dir (mktemp -d)

    echo "Generating icon set for '$name'..."
    echo "Output directory: $output_dir"

    # Download or read icon source
    set -l master_icon ""
    # Clean the input: remove quotes, newlines, and trim whitespace
    set -l icon_source_cleaned (string replace -a '\n' '' -- $icon_source | string trim -c '\'"' | string trim)

    if string match -q "http*://" "$icon_source_cleaned"
        # Download from URL
        echo "Downloading icon from URL..."
        set -l temp_download "$temp_dir/downloaded-icon"
        if curl -L -f -s -S --max-redirs 5 \
            -A "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" \
            -o "$temp_download" "$icon_source_cleaned"
            if test (stat -f%z "$temp_download" 2>/dev/null || stat -c%s "$temp_download" 2>/dev/null) -gt 0
                echo "âœ“ Icon downloaded successfully"
                set master_icon "$temp_download"
            else
                echo "âœ— Error: Downloaded icon file is empty"
                rm -rf "$temp_dir"
                return 1
            end
        else
            echo "âœ— Error: Failed to download icon from $icon_source_cleaned"
            rm -rf "$temp_dir"
            return 1
        end
    else
        # Local file path
        if test -f "$icon_source_cleaned"
            echo "Using local icon file: $icon_source_cleaned"
            set master_icon "$icon_source_cleaned"
        else
            echo "âœ— Error: Icon file not found at $icon_source_cleaned"
            rm -rf "$temp_dir"
            return 1
        end
    end

    # Convert to high-quality PNG
    set -l file_type (file -b --mime-type "$master_icon" 2>/dev/null)
    set -l master_png "$temp_dir/master.png"
    echo "Converting to PNG..."

    if string match -q "image/svg+xml" "$file_type"
        # SVG: Try rsvg-convert first (more robust for well-formed SVGs)
        rsvg-convert -w 1024 -h 1024 -f png "$master_icon" -o "$master_png" 2>/dev/null

        # If rsvg-convert fails, fall back to ImageMagick (more forgiving with malformed SVGs)
        if test $status -ne 0 -o ! -f "$master_png"
            echo "  âš  rsvg-convert failed, trying ImageMagick fallback..."
            convert -background none -density 1228.8 -resize 1024x1024 "$master_icon" -alpha on -define png:color-type=6 PNG32:"$master_png" 2>/dev/null
        end
    else
        # Raster format (PNG, JPG, etc.) - use ImageMagick
        convert "$master_icon" -alpha on -define png:color-type=6 PNG32:"$master_png"
    end

    if test $status -ne 0 -o ! -f "$master_png"
        echo "âœ— Error: Failed to convert icon to PNG (tried all available methods)"
        rm -rf "$temp_dir"
        return 1
    end

    echo "âœ“ Icon converted to PNG"

    # Apply background if requested
    set -l source_icon "$master_png"
    set -l resize_mode "aspect"

    if test "$add_background" -eq 1
        echo "Adding gray rounded background..."
        set -l processed_icon "$temp_dir/with-background.png"
        set -l bg_color "#636363"
        set -l canvas_size 1024
        set -l logo_padded_size (math $canvas_size \* 0.85)

        convert -size "$canvas_size"x"$canvas_size" xc:none \
            -draw "roundrectangle 0,0,$canvas_size,$canvas_size,100,100" "$temp_dir/mask.png"
        convert -size "$canvas_size"x"$canvas_size" xc:"$bg_color" "$temp_dir/mask.png" \
            -compose copy-opacity -composite "$temp_dir/background.png"
        convert "$temp_dir/background.png" \
            \( "$master_png" -filter Lanczos -resize "$logo_padded_size"x"$logo_padded_size" \) \
            -gravity center -compose over -composite \
            -define png:color-type=6 PNG32:"$processed_icon"

        if test $status -eq 0 -a -f "$processed_icon"
            echo "âœ“ Background added"
            set source_icon "$processed_icon"
            set resize_mode "exact"
        else
            echo "âœ— Warning: Failed to add background, using original"
        end
    end

    # Save master icon with proper naming
    cp "$source_icon" "$output_dir/$master_filename"
    echo "âœ“ Saved master icon: $master_filename"

    # Generate multi-sized icons
    set -l icon_sizes 16 32 48 64 128 256 512 800
    echo "Generating multi-sized icons..."

    for size in $icon_sizes
        set -l sized_icon "$output_dir/$size_filename_pattern-$size.png"

        if test "$resize_mode" = "exact"
            convert "$source_icon" -filter Lanczos -resize "$size"x"$size"! \
                -strip PNG32:"$sized_icon"
        else
            convert "$source_icon" -filter Lanczos -resize "$size"x"$size" \
                -background none -gravity center -extent "$size"x"$size" \
                -strip PNG32:"$sized_icon"
        end

        if test $status -ne 0
            echo "âœ— Error: Failed to create "$size"x"$size" icon"
            rm -rf "$temp_dir"
            return 1
        end
        echo "  âœ“ "$size"x"$size
    end

    # Cleanup
    rm -rf "$temp_dir"

    echo ""
    echo "âœ… Icon set generated successfully!"
    echo "   Master: $output_dir/$master_filename"
    echo "   Sizes: 16, 32, 48, 64, 128, 256, 512, 800"
    return 0
end

# ------------------------------------------------------------------------------
# INTERNAL HELPER: _create_ansible_tasks
# ------------------------------------------------------------------------------
function _create_ansible_tasks --description 'Internal helper to generate Ansible tasks and handlers'
    set -l name $argv[1]
    set -l role_path $argv[2]
    set -l app_state_key (echo "$name" | tr '-' '_')

    set -l binary_name (echo "$name" | tr -d '-')
    set desktop_content "[Desktop Entry]\nCategories=\nComment=ðŸ¤±ðŸ» Turn any webpage into a desktop app with Rust.\nExec=pake-$binary_name\nStartupWMClass=pake-$name\nIcon=pake-$name\nName=$name\nTerminal=false\nType=Application"
    echo -e $desktop_content > "$role_path/files/pake-$name.desktop"
    echo "âœ“ Generated desktop file."

{% raw %}
    set tasks_content "---\n# $name Pake App installation\n- name: Install $name .deb package\n  apt:\n    deb: '{{ role_path }}/files/$name.deb'\n    state: present\n  become: yes\n  when: app_states['$app_state_key'] | default('present') == 'present'\n\n- name: Remove .deb desktop files\n  file:\n    path: '{{ item }}'\n    state: absent\n  loop:\n    - /usr/share/applications/$name.desktop\n    - /usr/share/applications/com.pake.$name.desktop\n  become: yes\n  when: app_states['$app_state_key'] | default('present') == 'present'\n\n- name: Install custom desktop file and icons\n  copy:\n    src: '{{ item.src }}'\n    dest: '{{ item.dest }}'\n    mode: '0644'\n  loop:\n    - { src: 'pake-$name.desktop', dest: '/usr/share/applications/pake-$name.desktop' }\n    - { src: 'pake-$name-icon-16.png', dest: '/usr/share/icons/hicolor/16x16/apps/pake-$name.png' }\n    - { src: 'pake-$name-icon-32.png', dest: '/usr/share/icons/hicolor/32x32/apps/pake-$name.png' }\n    - { src: 'pake-$name-icon-48.png', dest: '/usr/share/icons/hicolor/48x48/apps/pake-$name.png' }\n    - { src: 'pake-$name-icon-64.png', dest: '/usr/share/icons/hicolor/64x64/apps/pake-$name.png' }\n    - { src: 'pake-$name-icon-128.png', dest: '/usr/share/icons/hicolor/128x128/apps/pake-$name.png' }\n    - { src: 'pake-$name-icon-256.png', dest: '/usr/share/icons/hicolor/256x256/apps/pake-$name.png' }\n    - { src: 'pake-$name-icon-512.png', dest: '/usr/share/icons/hicolor/512x512/apps/pake-$name.png' }\n    - { src: 'pake-$name-icon-800.png', dest: '/usr/share/icons/hicolor/scalable/apps/pake-$name.png' }\n  become: yes\n  when: app_states['$app_state_key'] | default('present') == 'present'\n  notify: Update icon cache\n\n# Cleanup when absent\n- name: Remove $name Pake app\n  apt:\n    name: $name\n    state: absent\n  become: yes\n  when: app_states['$app_state_key'] | default('present') == 'absent'\n"
    echo -e $tasks_content > "$role_path/tasks/main.yml"
    echo "âœ“ Created tasks/main.yml."

    set handlers_content "---\n- name: Update icon cache\n  command: gtk-update-icon-cache -f /usr/share/icons/hicolor\n  become: yes\n  changed_when: false\n"
    echo -e $handlers_content > "$role_path/handlers/main.yml"
    echo "âœ“ Created handlers/main.yml."
{% endraw %}

    return 0
end

# ------------------------------------------------------------------------------
# MAIN FUNCTION: create-web-app
# ------------------------------------------------------------------------------
function create-web-app --description 'Build desktop apps from websites using Pake via Docker (no icon generation)'
    # Validate arguments
    if test (count $argv) -lt 2
        echo "Usage: create-web-app <app_url> <name> [pake-options...]"
        echo ""
        echo "Examples:"
        echo "  create-web-app https://github.com github"
        echo "  create-web-app https://mail.google.com gmail --width 1600 --height 1000"
        return 1
    end

    set -l url $argv[1]
    set -l name $argv[2]
    set -l pake_options $argv[3..-1]

    # Check dependencies
    if not command -v docker &>/dev/null
        echo "âœ— Error: docker is required"
        return 1
    end

    set -l repo_path ~/dev/iac/desktoperator
    set -l role_path "$repo_path/roles/apps/$name-pake"

    # Check if icons exist (must be generated first!)
    if not test -d "$role_path/files"
        echo "âœ— Error: Role directory not found at $role_path/files"
        echo ""
        echo "Icons must be generated FIRST. Run:"
        echo "  generate-icon-set <icon_url> $name"
        return 1
    end

    set -l master_icon "$role_path/files/pake-$name-icon.png"
    if not test -f "$master_icon"
        echo "âœ— Error: Master icon not found at $master_icon"
        echo ""
        echo "Icons must be generated FIRST. Run:"
        echo "  generate-icon-set <icon_url> $name"
        return 1
    end

    echo "Building Pake app: $name"
    echo "URL: $url"
    echo "Using icon: $master_icon"

    # Create temp directory and copy icon for Pake build
    set -l output_dir (mktemp -d)
    cp "$master_icon" "$output_dir/icon.png"

    # Build .deb with Pake using our icon
    set -l pake_args $url --name $name --targets deb --icon /output/icon.png $pake_options
    set -l docker_output "$output_dir/docker-build.log"

    echo ""
    echo "Running Pake Docker build..."
    docker run --rm --privileged --device /dev/fuse --security-opt apparmor=unconfined \
        -e NO_STRIP=1 -v "$output_dir":/output \
        ghcr.io/tw93/pake $pake_args 2>&1 | tee "$docker_output"

    set -l pake_result $status

    if test $pake_result -eq 0
        # Copy .deb to role files/
        set -l deb_file (find "$output_dir" -name "*.deb" -type f | head -n 1)
        if test -z "$deb_file"
            echo "âœ— Error: Could not find built .deb package"
            rm -rf "$output_dir"
            return 1
        end
        cp "$deb_file" "$role_path/files/$name.deb"
        echo "âœ“ Copied .deb package to role"

        # Generate Ansible tasks and handlers
        _create_ansible_tasks $name $role_path
        if test $status -eq 0
            echo ""
            echo "âœ… Successfully created Pake app and Ansible role for '$name'."
            echo "   Role: $role_path"
            echo ""
            echo "Next step: Deploy with ansible-playbook site.yml --tags $name"
        end
    else
        echo "âœ— Pake build failed. See log for details: $docker_output"
    end

    rm -rf "$output_dir"
    return $pake_result
end

# Note: regenerate-pake-icons function has been removed.
# Use generate-icon-set directly - it outputs to the Ansible role by default.

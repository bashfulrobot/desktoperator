# Pake Docker wrapper functions
# Contains:
#   - _generate_pake_icons: (Internal) Helper to fetch and process icons.
#   - _create_ansible_role_scaffolding: (Internal) Helper to create the Ansible role structure.
#   - create-web-app: Main function to build a new Pake app and role.
#   - regenerate-pake-icons: Main function to regenerate icons for an existing role.

# ------------------------------------------------------------------------------
# INTERNAL HELPER: _generate_pake_icons
# ------------------------------------------------------------------------------
function _generate_pake_icons --description 'Internal helper to fetch, process, and generate icons'
    set -l url $argv[1]
    set -l name $argv[2]
    set -l custom_domain $argv[3]
    set -l output_dir $argv[4]
    set -l add_background $argv[5]
    set -l user_icon_path $argv[6]

    set -l master_icon ""
    set -l pake_icon_path ""

    if test -n "$user_icon_path"
        # Clean the input path of any surrounding quotes
        set -l cleaned_icon_path (string trim -c '\'"' -- $user_icon_path)

        # Handle user-provided icon, which can be a local path or a URL
        if string match -q "http*://" "$cleaned_icon_path"
            echo "Downloading user-provided icon from URL: $cleaned_icon_path"
            set -l temp_download "$output_dir/user-icon-download"
            if curl -L -f -s -o "$temp_download" "$cleaned_icon_path"
                if test (stat -f%z "$temp_download" 2>/dev/null || stat -c%s "$temp_download" 2>/dev/null) -gt 0
                    echo "âœ“ Icon downloaded successfully."
                    set master_icon "$output_dir/master-icon.png"
                    # Process the downloaded file
                    convert "$temp_download" -alpha on -define png:color-type=6 PNG32:"$master_icon"
                else
                    echo "âœ— Error: Downloaded icon file is empty."
                    return 1
                end
            else
                echo "âœ— Error: Failed to download icon from $cleaned_icon_path"
                return 1
            end
        else
            # Assume it's a local file path
            echo "Using user-provided local icon: $cleaned_icon_path"
            if test -f "$cleaned_icon_path"
                set master_icon "$output_dir/master-icon.png"
                convert "$cleaned_icon_path" -alpha on -define png:color-type=6 PNG32:"$master_icon"
            else
                echo "âœ— Error: Icon file not found at $cleaned_icon_path"
                return 1
            end
        end
    else
        # If no user icon, proceed with Brandfetch logic
        echo "No custom icon provided, attempting to fetch logo from Brandfetch..."
        set -l domain ""
        if test -n "$custom_domain"
            set domain (echo "$custom_domain" | sed -E 's|^https?://||' | sed -E 's|/.*$||' | sed -E 's|^www\\.||')
        else
            set -l full_domain (echo "$url" | sed -E 's|^https?://||' | sed -E 's|/.*$||' | sed -E 's|^www\\.||')
            set domain (echo "$full_domain" | awk -F. '{ if (NF == 2) { print $0 } else if (NF > 2 && ($(NF-1) == "co" || $(NF-1) == "com" || $(NF-1) == "gov" || $(NF-1) == "ac")) { print $(NF-2)"."$(NF-1)"."$NF } else { print $(NF-1)"."$NF } }')
        end
        echo "Using domain: $domain"

        if test -n "$domain"
            echo "Querying Brandfetch API..."
            set -l brand_json "$output_dir/brandfetch.json"
            if curl -L -f -s -H "Authorization: Bearer $BRANDFETCH_API_KEY" "https://api.brandfetch.io/v2/brands/$domain" -o "$brand_json" 2>/dev/null
                set -l logo_url (jq -r '.logos[] | select(.type == "icon") | .formats[] | select(.format == "svg") | .src' "$brand_json" 2>/dev/null | head -n 1)
                if test -z "$logo_url"; or test "$logo_url" = "null"; set logo_url (jq -r '.logos[] | select(.type == "logo") | .formats[] | select(.format == "svg") | .src' "$brand_json" 2>/dev/null | head -n 1); end
                if test -z "$logo_url"; or test "$logo_url" = "null"; set logo_url (jq -r '.logos[] as $logo | $logo.formats[] | select(.format == "png") | { src, width: (.width // 0), height: (.height // 0), type: $logo.type, theme: (.theme // "none"), type_score: (if $logo.type == "icon" then 1000 else 0 end), theme_score: (if .theme == "light" then 100 elif .theme == "dark" then 50 else 75 end), size_score: ( if ([.width // 0, .height // 0] | max) >= 800 then 10 elif ([.width // 0, .height // 0] | max) >= 512 then 8 elif ([.width // 0, .height // 0] | max) >= 256 then 5 else 1 end ), area: ((.width // 0) * (.height // 0)) } | select(.area > 0) | . + {total_score: (.type_score + .theme_score + .size_score)}' "$brand_json" 2>/dev/null | jq -sr 'sort_by(-.total_score, -.area) | .[0].src' 2>/dev/null); end
                if test -z "$logo_url"; or test "$logo_url" = "null"; set logo_url (jq -r '.logos[].formats[] | select(.format == "jpeg" or .format == "jpg" or .format == "webp") | .src' "$brand_json" 2>/dev/null | head -n 1); end

                if test -n "$logo_url"
                    echo "Logo URL: $logo_url"
                    set -l temp_download "$output_dir/logo-download"
                    if curl -L -f -s -o "$temp_download" "$logo_url" 2>/dev/null
                        if test (stat -f%z "$temp_download" 2>/dev/null || stat -c%s "$temp_download" 2>/dev/null) -gt 0
                            echo "âœ“ Logo downloaded successfully."
                            set -l file_type (file -b --mime-type "$temp_download" 2>/dev/null)
                            set master_icon "$output_dir/master-icon.png"
                            echo "Creating high-quality master PNG icon..."
                            if string match -q "image/svg+xml" "$file_type"
                                convert -background none -density 1228.8 -resize 1024x1024 "$temp_download" -alpha on -define png:color-type=6 PNG32:"$master_icon"
                            else
                                convert "$temp_download" -alpha on -define png:color-type=6 PNG32:"$master_icon"
                            end
                        end
                    end
                end
            end
        end
    end

    if test -z "$master_icon" -o ! -f "$master_icon"
        echo "âœ— Could not find or fetch an icon. Pake will use its default."
        return 1
    end

    set -l source_icon $master_icon
    set -l resize_mode "aspect"
    set pake_icon_path "/output/master-icon.png"

    if test "$add_background" -eq 1
        echo "Creating themed app icon with neutral background..."
        set -l processed_icon "$output_dir/processed-icon.png"
        set -l bg_color "#6B7280"
        set -l canvas_size 1024
        set -l logo_padded_size (math $canvas_size \* 0.85)
        convert -size "$canvas_size"x"$canvas_size" xc:none -draw "roundrectangle 0,0,$canvas_size,$canvas_size,100,100" "$output_dir/mask.png"
        convert -size "$canvas_size"x"$canvas_size" xc:"$bg_color" "$output_dir/mask.png" -compose copy-opacity -composite "$output_dir/background.png"
        convert "$output_dir/background.png" \( "$master_icon" -filter Lanczos -resize \"$logo_padded_size\"x\"$logo_padded_size\" \) -gravity center -compose over -composite -define png:color-type=6 PNG32:"$processed_icon"
        if test $status -eq 0 -a -f "$processed_icon"
            echo "âœ“ Created themed app icon."
            set source_icon $processed_icon
            set resize_mode "exact"
            set pake_icon_path "/output/processed-icon.png"
        else
            echo "âœ— Failed to create themed icon. Using original logo."
        end
    end

    set -l icon_sizes 16 32 48 64 128 256 512 800
    echo "Generating high-quality multi-size icons..."
    for size in $icon_sizes
        set -l scaled_icon "$output_dir/icon-$size.png"
        if test "$resize_mode" = "exact"
            convert "$source_icon" -filter Lanczos -resize "$size"x"$size"! -strip PNG32:"$scaled_icon"
        else
            convert "$source_icon" -filter Lanczos -resize "$size"x"$size" -background none -gravity center -extent "$size"x"$size" -strip PNG32:"$scaled_icon"
        end

        if test $status -ne 0
            echo "âœ— Error: ImageMagick failed to create icon for size $size."
            return 1
        end
    end

    echo $pake_icon_path
    return 0
end

# ------------------------------------------------------------------------------
# INTERNAL HELPER: _create_ansible_role_scaffolding
# ------------------------------------------------------------------------------
function _create_ansible_role_scaffolding --description 'Internal helper to create Ansible role structure'
    set -l name $argv[1]
    set -l output_dir $argv[2]
    set -l role_path $argv[3]
    set -l app_state_key (echo "$name" | tr '-' '_')

    echo "Creating Ansible role structure at $role_path..."
    mkdir -p "$role_path"/{files,tasks,handlers}

    set -l deb_file (find "$output_dir" -name "*.deb" -type f | head -n 1)
    if test -z "$deb_file"
        echo "âœ— Error: Could not find built .deb package in $output_dir"
        return 1
    end
    cp "$deb_file" "$role_path/files/$name.deb"
    echo "âœ“ Copied .deb package."

    set -l icon_sizes 16 32 48 64 128 256 512 800
    for size in $icon_sizes
        if test -f "$output_dir/icon-$size.png"
            cp "$output_dir/icon-$size.png" "$role_path/files/pake-$name-icon-$size.png"
        end
    end
    echo "âœ“ Copied all generated icons."

    set -l binary_name (echo "$name" | tr -d '-')
    set desktop_content "[Desktop Entry]\nCategories=\nComment=ðŸ¤±ðŸ» Turn any webpage into a desktop app with Rust.\nExec=pake-$binary_name\nStartupWMClass=pake-$name\nIcon=pake-$name\nName=$name\nTerminal=false\nType=Application"
    echo -e $desktop_content > "$role_path/files/pake-$name.desktop"
    echo "âœ“ Generated desktop file."

{% raw %}
    set tasks_content "---\n# $name Pake App installation\n- name: Install $name .deb package\n  apt:\n    deb: '{{ role_path }}/files/$name.deb'\n    state: present\n  become: yes\n  when: app_states['$app_state_key'] | default('present') == 'present'\n\n- name: Remove .deb desktop files\n  file:\n    path: '{{ item }}'\n    state: absent\n  loop:\n    - /usr/share/applications/$name.desktop\n    - /usr/share/applications/com.pake.$name.desktop\n  become: yes\n  when: app_states['$app_state_key'] | default('present') == 'present'\n\n- name: Install custom desktop file and icons\n  copy:\n    src: '{{ item.src }}'\n    dest: '{{ item.dest }}'\n    mode: '0644'\n  loop:\n    - { src: 'pake-$name.desktop', dest: '/usr/share/applications/pake-$name.desktop' }\n    - { src: 'pake-$name-icon-16.png', dest: '/usr/share/icons/hicolor/16x16/apps/pake-$name.png' }\n    - { src: 'pake-$name-icon-32.png', dest: '/usr/share/icons/hicolor/32x32/apps/pake-$name.png' }\n    - { src: 'pake-$name-icon-48.png', dest: '/usr/share/icons/hicolor/48x48/apps/pake-$name.png' }\n    - { src: 'pake-$name-icon-64.png', dest: '/usr/share/icons/hicolor/64x64/apps/pake-$name.png' }\n    - { src: 'pake-$name-icon-128.png', dest: '/usr/share/icons/hicolor/128x128/apps/pake-$name.png' }\n    - { src: 'pake-$name-icon-256.png', dest: '/usr/share/icons/hicolor/256x256/apps/pake-$name.png' }\n    - { src: 'pake-$name-icon-512.png', dest: '/usr/share/icons/hicolor/512x512/apps/pake-$name.png' }\n    - { src: 'pake-$name-icon-800.png', dest: '/usr/share/icons/hicolor/scalable/apps/pake-$name.png' }\n  become: yes\n  when: app_states['$app_state_key'] | default('present') == 'present'\n  notify: Update icon cache\n\n# Cleanup when absent\n- name: Remove $name Pake app\n  apt:\n    name: $name\n    state: absent\n  become: yes\n  when: app_states['$app_state_key'] | default('present') == 'absent'\n"
    echo -e $tasks_content > "$role_path/tasks/main.yml"
    echo "âœ“ Created tasks/main.yml."

    set handlers_content "---\n- name: Update icon cache\n  command: gtk-update-icon-cache -f /usr/share/icons/hicolor\n  become: yes\n  changed_when: false\n"
    echo -e $handlers_content > "$role_path/handlers/main.yml"
    echo "âœ“ Created handlers/main.yml."
{% endraw %}

    return 0
end

# ------------------------------------------------------------------------------
# MAIN FUNCTION: create-web-app
# ------------------------------------------------------------------------------
function create-web-app --description 'Build desktop apps from websites using Pake via Docker'
    if test (count $argv) -eq 1; and test "$argv[1]" = "--help" -o "$argv[1]" = "-h"; echo "create-web-app - Docs in file"; return 0; end

    set -l url $argv[1]
    set -l name $argv[2]
    set -l custom_domain ""
    set -l extra_args_start 3
    if test (count $argv) -ge 3
        if not string match -q -- '--*' $argv[3]
            set custom_domain $argv[3]
            set extra_args_start 4
        end
    end
    set -l extra_args $argv[$extra_args_start..-1]

    set -l add_background 0
    set -l user_icon_path ""
    set -l pake_run_args
    set -l i 1
    while test $i -le (count $extra_args)
        set -l arg $extra_args[$i]
        switch $arg
            case '--add-background'
                set add_background 1
            case '--icon'
                set i (math $i + 1)
                set user_icon_path $extra_args[$i]
            case '*'
                set pake_run_args $pake_run_args $arg
        end
        set i (math $i + 1)
    end

    if not command -v docker &>/dev/null; or not command -v jq &>/dev/null; or not command -v convert &>/dev/null
        echo "Error: docker, jq, and imagemagick are required."
        return 1
    end

    set -l output_dir (mktemp -d)
    set -l repo_path ~/dev/iac/desktoperator
    set -l role_path "$repo_path/roles/apps/$name-pake"
    echo "Building $name... Temp directory: $output_dir"

    set -l pake_icon_path (_generate_pake_icons $url $name $custom_domain $output_dir $add_background $user_icon_path)
    set -l icon_result $status

    set -l pake_args $url --name $name --targets deb $pake_run_args
    if test $icon_result -eq 0
        set pake_args $pake_args --icon $pake_icon_path
    end

    set -l docker_output "$output_dir/docker-build.log"
    docker run --rm --privileged --device /dev/fuse --security-opt apparmor=unconfined -e NO_STRIP=1 -v "$output_dir":/output ghcr.io/tw93/pake $pake_args 2>&1 | tee "$docker_output"
    set -l pake_result $status

    if test $pake_result -eq 0
        _create_ansible_role_scaffolding $name $output_dir $role_path
        if test $status -eq 0
            echo ""
            echo "âœ… Successfully created Pake app and Ansible role for '$name'."
            echo "To enable it, add '$name: present' to your app_states config and include the role."
        end
    else
        echo "âœ— Pake build failed. See log for details: $docker_output"
    end

    rm -rf "$output_dir"
    return $pake_result
end

# ------------------------------------------------------------------------------
# MAIN FUNCTION: regenerate-pake-icons
# ------------------------------------------------------------------------------
function regenerate-pake-icons --description 'Regenerate icons for an existing Pake Ansible role'
    if test (count $argv) -eq 1; and test "$argv[1]" = "--help" -o "$argv[1]" = "-h"; echo "regenerate-pake-icons - Docs in file"; return 0; end

    set -l url $argv[1]
    set -l name $argv[2]
    set -l custom_domain ""
    set -l extra_args_start 3
    if test (count $argv) -ge 3
        if not string match -q -- '--*' $argv[3]
            set custom_domain $argv[3]
            set extra_args_start 4
        end
    end
    set -l extra_args $argv[$extra_args_start..-1]

    set -l add_background 0
    set -l user_icon_path ""
    set -l i 1
    while test $i -le (count $extra_args)
        set -l arg $extra_args[$i]
        switch $arg
            case '--add-background'
                set add_background 1
            case '--icon'
                set i (math $i + 1)
                set user_icon_path $extra_args[$i]
        end
        set i (math $i + 1)
    end

    if not command -v jq &>/dev/null; or not command -v convert &>/dev/null
        echo "Error: jq and imagemagick are required."
        return 1
    end

    set -l output_dir (mktemp -d)
    set -l repo_path ~/dev/iac/desktoperator
    set -l role_path "$repo_path/roles/apps/$name-pake"

    if not test -d "$role_path/files"
        echo "âœ— Error: Role directory not found at $role_path/files"
        rm -rf "$output_dir"
        return 1
    end

    echo "Regenerating icons for '$name' in $role_path..."

    _generate_pake_icons $url $name $custom_domain $output_dir $add_background $user_icon_path
    if test $status -ne 0
        echo "âœ— Icon generation failed. Aborting."
        rm -rf "$output_dir"
        return 1
    end

    echo "Copying new icons to role..."
    set -l icon_sizes 16 32 48 64 128 256 512 800
    set -l copied_count 0
    for size in $icon_sizes
        set -l source_file "$output_dir/icon-$size.png"
        if test -f "$source_file"
            cp "$source_file" "$role_path/files/pake-$name-icon-$size.png"
            echo "  âœ“ Replaced $size x $size icon"
            set copied_count (math $copied_count + 1)
        else
            echo "  âœ— Warning: Could not find generated icon for size $size."
        end
    end

    if test $copied_count -eq 0
        echo ""
        echo "âœ— Error: No icons were generated or copied. The icon processing step likely failed."
        echo "Contents of temporary directory ($output_dir):"
        ls -l "$output_dir"
        rm -rf "$output_dir"
        return 1
    end

    rm -rf "$output_dir"
    echo ""
    echo "âœ… Successfully regenerated and replaced icons for '$name'."
    echo "Run ansible-playbook with the '$name' tag to deploy the new icons."
    return 0
end

---
# Chromium installation via xtradeb PPA
# https://launchpad.net/~xtradeb/+archive/ubuntu/apps

- name: Download Chromium PPA GPG key
  ansible.builtin.get_url:
    url: https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x5301FA4FD93244FBC6F6149982BB6851C64F6880
    dest: /tmp/chromium-ppa.gpg
    mode: "0644"
  when: app_states['chromium'] | default('present') == 'present'

- name: Add Chromium PPA GPG key to keyring
  ansible.builtin.shell: |
    gpg --dearmor < /tmp/chromium-ppa.gpg > /usr/share/keyrings/xtradeb-apps.gpg
    chmod 644 /usr/share/keyrings/xtradeb-apps.gpg
  args:
    creates: /usr/share/keyrings/xtradeb-apps.gpg
  become: true
  when: app_states['chromium'] | default('present') == 'present'

- name: Clean up temporary GPG key file
  ansible.builtin.file:
    path: /tmp/chromium-ppa.gpg
    state: absent
  when: app_states['chromium'] | default('present') == 'present'

# Remove old GPG key location if it exists
- name: Remove legacy Chromium PPA GPG key
  ansible.builtin.file:
    path: /etc/apt/trusted.gpg.d/xtradeb_ubuntu_apps.gpg
    state: absent
  become: true
  when: app_states['chromium'] | default('present') == 'present'

# Remove old PPA repository format (must be done before adding new format)
- name: Remove old Chromium PPA repository file
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/ppa_xtradeb_apps_noble.list
    state: absent
  become: true
  when: app_states['chromium'] | default('present') == 'present'

# Explicitly specify arch=amd64 and signed-by to use modern keyring
# For ARM support, change arch=amd64 to arch=amd64,arm64
- name: Add Chromium PPA repository with modern keyring
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/xtradeb-apps.gpg] https://ppa.launchpadcontent.net/xtradeb/apps/ubuntu noble main"
    filename: chromium-ppa
    state: present
  become: true
  when: app_states['chromium'] | default('present') == 'present'

- name: Update apt cache after adding PPA
  ansible.builtin.apt:
    update_cache: true
  become: true
  when: app_states['chromium'] | default('present') == 'present'

# APT pinning - prioritizes Chromium from xtradeb PPA
- name: Create APT preferences directory
  ansible.builtin.file:
    path: /etc/apt/preferences.d
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true
  when:
    - app_states['chromium'] | default('present') == 'present'
    - chromium_apt_pin_enabled | default(true)

- name: Pin Chromium package to xtradeb PPA
  ansible.builtin.copy:
    content: |
      # Managed by Ansible - prioritizes Chromium from xtradeb PPA
      Package: chromium*
      Pin: release o=LP-PPA-xtradeb-apps
      Pin-Priority: {{ chromium_apt_pin_priority }}
    dest: /etc/apt/preferences.d/chromium-pin
    owner: root
    group: root
    mode: "0644"
  become: true
  when:
    - app_states['chromium'] | default('present') == 'present'
    - chromium_apt_pin_enabled | default(true)

- name: Install Chromium
  ansible.builtin.apt:
    name: chromium
    state: present
  become: true
  when: app_states['chromium'] | default('present') == 'present'

# 1Password Integration for Chromium
- name: Create 1Password config directory
  ansible.builtin.file:
    path: /etc/1password
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true
  when: app_states['chromium'] | default('present') == 'present'

- name: Add Chromium to 1Password allowed browsers
  ansible.builtin.blockinfile:
    path: /etc/1password/custom_allowed_browsers
    block: |
      chromium
      chromium-browser
    create: true
    owner: root
    group: root
    mode: "0755"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Chromium"
  become: true
  when: app_states['chromium'] | default('present') == 'present'

# Cleanup when absent
- name: Remove Chromium when absent
  ansible.builtin.apt:
    name: chromium
    state: absent
    purge: true
  become: true
  when: app_states['chromium'] | default('present') == 'absent'

- name: Remove Chromium PPA repository when absent
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/xtradeb-apps.gpg] https://ppa.launchpadcontent.net/xtradeb/apps/ubuntu noble main"
    filename: chromium-ppa
    state: absent
  become: true
  when: app_states['chromium'] | default('present') == 'absent'

- name: Remove Chromium PPA GPG key when absent
  ansible.builtin.file:
    path: /usr/share/keyrings/xtradeb-apps.gpg
    state: absent
  become: true
  when: app_states['chromium'] | default('present') == 'absent'

- name: Remove legacy Chromium PPA GPG key when absent
  ansible.builtin.file:
    path: /etc/apt/trusted.gpg.d/xtradeb_ubuntu_apps.gpg
    state: absent
  become: true
  when: app_states['chromium'] | default('present') == 'absent'

- name: Remove old Chromium PPA repository file when absent
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/ppa_xtradeb_apps_noble.list
    state: absent
  become: true
  when: app_states['chromium'] | default('present') == 'absent'

- name: Remove Chromium APT pin when absent
  ansible.builtin.file:
    path: /etc/apt/preferences.d/chromium-pin
    state: absent
  become: true
  when: app_states['chromium'] | default('present') == 'absent'

- name: Remove Chromium from 1Password allowed browsers when absent
  ansible.builtin.blockinfile:
    path: /etc/1password/custom_allowed_browsers
    block: ""
    state: absent
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Chromium"
  become: true
  when: app_states['chromium'] | default('present') == 'absent'
  failed_when: false

---
# Starship prompt installation and configuration

- name: Check if starship is installed
  ansible.builtin.command: which starship
  register: starship_installed
  changed_when: false
  failed_when: false
  when: app_states['starship'] | default('present') == 'present'

- name: Download starship installer
  ansible.builtin.get_url:
    url: https://starship.rs/install.sh
    dest: /tmp/starship-install.sh
    mode: "0755"
  when:
    - app_states['starship'] | default('present') == 'present'
    - starship_installed.rc != 0

- name: Install starship
  ansible.builtin.command: /tmp/starship-install.sh --yes
  become: true
  when:
    - app_states['starship'] | default('present') == 'present'
    - starship_installed.rc != 0

- name: Clean up starship installer
  ansible.builtin.file:
    path: /tmp/starship-install.sh
    state: absent
  when:
    - app_states['starship'] | default('present') == 'present'
    - starship_installed.rc != 0

- name: Deploy starship configuration
  ansible.builtin.template:
    src: starship.toml.j2
    dest: "{{ user.home }}/.config/starship.toml"
    owner: "{{ user.name }}"
    mode: "0644"
  when: app_states['starship'] | default('present') == 'present'

- name: Ensure Fish conf.d directory exists
  ansible.builtin.file:
    path: "{{ user.home }}/.config/fish/conf.d"
    state: directory
    owner: "{{ user.name }}"
    mode: "0755"
  when: app_states['starship'] | default('present') == 'present'

- name: Deploy Fish configuration for starship
  ansible.builtin.template:
    src: starship.fish.j2
    dest: "{{ user.home }}/.config/fish/conf.d/starship.fish"
    owner: "{{ user.name }}"
    mode: "0644"
  when: app_states['starship'] | default('present') == 'present'

# Cleanup when absent
- name: Remove starship binary when absent
  ansible.builtin.file:
    path: /usr/local/bin/starship
    state: absent
  become: true
  when: app_states['starship'] | default('present') == 'absent'

- name: Remove starship configuration when absent
  ansible.builtin.file:
    path: "{{ user.home }}/.config/starship.toml"
    state: absent
  when: app_states['starship'] | default('present') == 'absent'

- name: Remove Fish configuration for starship when absent
  ansible.builtin.file:
    path: "{{ user.home }}/.config/fish/conf.d/starship.fish"
    state: absent
  when: app_states['starship'] | default('present') == 'absent'

---
# Trippy network diagnostic tool installation
# https://github.com/fujiapple852/trippy

- name: Install software-properties-common for add-apt-repository
  ansible.builtin.apt:
    name: software-properties-common
    state: present
  become: true
  when: app_states['trippy'] | default('present') == 'present'

- name: Add Trippy PPA
  ansible.builtin.apt_repository:
    repo: ppa:fujiapple/trippy
    state: present
    update_cache: false
  become: true
  when: app_states['trippy'] | default('present') == 'present'

- name: Update apt cache after adding PPA
  ansible.builtin.apt:
    update_cache: true
  become: true
  when: app_states['trippy'] | default('present') == 'present'

- name: Install Trippy
  ansible.builtin.apt:
    name: trippy
    state: present
  become: true
  when: app_states['trippy'] | default('present') == 'present'

# Fish shell integration
- name: Create fish conf.d directory
  ansible.builtin.file:
    path: "{{ user.home }}/.config/fish/conf.d"
    state: directory
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0755"
  when: app_states['trippy'] | default('present') == 'present'

- name: Deploy fish aliases for trippy
  ansible.builtin.template:
    src: trippy.fish.j2
    dest: "{{ user.home }}/.config/fish/conf.d/trippy.fish"
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0644"
  when: app_states['trippy'] | default('present') == 'present'

# Bash shell integration for root user
- name: Deploy bash aliases for trippy to root's bash_aliases
  ansible.builtin.template:
    src: bash_aliases.j2
    dest: /root/.bash_aliases
    owner: root
    group: root
    mode: "0644"
  become: true
  when: app_states['trippy'] | default('present') == 'present'

- name: Remove old bash aliases from profile.d (migration cleanup)
  ansible.builtin.file:
    path: /etc/profile.d/trippy.sh
    state: absent
  become: true
  when: app_states['trippy'] | default('present') == 'present'

# Trippy configuration
- name: Create trippy config directory
  ansible.builtin.file:
    path: "{{ user.home }}/.config/trippy"
    state: directory
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0755"
  when: app_states['trippy'] | default('present') == 'present'

- name: Deploy trippy configuration file
  ansible.builtin.template:
    src: trippy.toml.j2
    dest: "{{ user.home }}/.config/trippy/trippy.toml"
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0644"
  when: app_states['trippy'] | default('present') == 'present'

# Root user configuration
- name: Create trippy config directory for root
  ansible.builtin.file:
    path: /root/.config/trippy
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true
  when: app_states['trippy'] | default('present') == 'present'

- name: Deploy trippy configuration file for root
  ansible.builtin.template:
    src: trippy.toml.j2
    dest: /root/.config/trippy/trippy.toml
    owner: root
    group: root
    mode: "0644"
  become: true
  when: app_states['trippy'] | default('present') == 'present'

# Cleanup when absent
- name: Remove Trippy when absent
  ansible.builtin.apt:
    name: trippy
    state: absent
    purge: true
  become: true
  when: app_states['trippy'] | default('present') == 'absent'

- name: Remove Trippy PPA when absent
  ansible.builtin.apt_repository:
    repo: ppa:fujiapple/trippy
    state: absent
  become: true
  when: app_states['trippy'] | default('present') == 'absent'

- name: Remove fish aliases for trippy when absent
  ansible.builtin.file:
    path: "{{ user.home }}/.config/fish/conf.d/trippy.fish"
    state: absent
  when: app_states['trippy'] | default('present') == 'absent'

- name: Remove trippy configuration directory when absent
  ansible.builtin.file:
    path: "{{ user.home }}/.config/trippy"
    state: absent
  when: app_states['trippy'] | default('present') == 'absent'

- name: Remove bash aliases from root when absent
  ansible.builtin.file:
    path: /root/.bash_aliases
    state: absent
  become: true
  when: app_states['trippy'] | default('present') == 'absent'

- name: Remove old bash aliases from profile.d (migration cleanup)
  ansible.builtin.file:
    path: /etc/profile.d/trippy.sh
    state: absent
  become: true

- name: Remove root trippy configuration directory when absent
  ansible.builtin.file:
    path: /root/.config/trippy
    state: absent
  become: true
  when: app_states['trippy'] | default('present') == 'absent'

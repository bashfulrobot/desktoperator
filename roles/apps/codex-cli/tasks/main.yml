---
# Codex CLI installation tasks

- name: Install Codex CLI globally via npm
  ansible.builtin.command: npm install -g @openai/codex
  become: true
  when: app_states['codex-cli'] | default('present') == 'present'
  register: codex_cli_install
  failed_when: false
  changed_when: codex_cli_install.rc == 0

- name: Create .codex directory
  ansible.builtin.file:
    path: "{{ user.home }}/.codex"
    state: directory
    owner: "{{ user.name }}"
    mode: "0755"
  when: app_states['codex-cli'] | default('present') == 'present'

- name: Deploy Codex global AGENTS.md
  ansible.builtin.copy:
    src: AGENTS.md
    dest: "{{ user.home }}/.codex/AGENTS.md"
    owner: "{{ user.name }}"
    mode: "0644"
  when: app_states['codex-cli'] | default('present') == 'present'

- name: Deploy Codex global config.toml
  ansible.builtin.copy:
    src: config.toml
    dest: "{{ user.home }}/.codex/config.toml"
    owner: "{{ user.name }}"
    mode: "0644"
  when: app_states['codex-cli'] | default('present') == 'present'

- name: Create Codex CLI prompts directory
  ansible.builtin.file:
    path: "{{ codex_cli_config_dir }}/prompts"
    state: directory
    owner: "{{ user.name }}"
    mode: "0755"
  when: app_states['codex-cli'] | default('present') == 'present'

- name: Deploy commit command prompt
  ansible.builtin.copy:
    src: prompts/commit.md
    dest: "{{ codex_cli_config_dir }}/prompts/commit.md"
    owner: "{{ user.name }}"
    mode: "0644"
  when: app_states['codex-cli'] | default('present') == 'present'

- name: Uninstall Codex CLI globally via npm
  ansible.builtin.command: npm uninstall -g @openai/codex
  become: true
  when: app_states['codex-cli'] | default('present') == 'absent'
  register: codex_cli_uninstall
  failed_when: false
  changed_when: codex_cli_uninstall.rc == 0

- name: Remove .codex configuration directory
  ansible.builtin.file:
    path: "{{ user.home }}/.codex"
    state: absent
  when: app_states['codex-cli'] | default('present') == 'absent'

- name: Remove Fish completions for Codex CLI when absent
  ansible.builtin.file:
    path: "{{ user.home }}/.config/fish/conf.d/codex-cli.fish"
    state: absent
  when: app_states['codex-cli'] | default('present') == 'absent'

- name: Remove Codex CLI config when absent
  ansible.builtin.file:
    path: "{{ codex_cli_config_file }}"
    state: absent
  when: app_states['codex-cli'] | default('present') == 'absent'

- name: Remove Codex CLI prompts directory when absent
  ansible.builtin.file:
    path: "{{ codex_cli_config_dir }}/prompts"
    state: absent
  when: app_states['codex-cli'] | default('present') == 'absent'

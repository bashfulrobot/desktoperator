---
# Helix editor installation and configuration

- name: Install software-properties-common for add-apt-repository
  ansible.builtin.apt:
    name:
      - software-properties-common
      - gpg
    state: present
  become: true
  when: app_states.helix | default('present') == 'present'

- name: Download Helix PPA GPG key
  ansible.builtin.get_url:
    url: https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x27642B9FD7F1A161FC2524E3355A4FA515D7C855
    dest: /tmp/helix-ppa.asc
    mode: "0644"
  become: true
  when: app_states.helix | default('present') == 'present'

- name: Add Helix PPA GPG key to keyrings
  ansible.builtin.shell: |
    gpg --dearmor < /tmp/helix-ppa.asc > /usr/share/keyrings/helix-ppa.gpg
    chmod 644 /usr/share/keyrings/helix-ppa.gpg
  args:
    creates: /usr/share/keyrings/helix-ppa.gpg
  become: true
  when: app_states.helix | default('present') == 'present'

- name: Clean up temporary Helix GPG key file
  ansible.builtin.file:
    path: /tmp/helix-ppa.asc
    state: absent
  become: true
  when: app_states.helix | default('present') == 'present'

# Explicitly specify arch=amd64 to prevent i386 package lookup warnings
# For ARM support, change arch=amd64 to arch=amd64,arm64
- name: Add Helix PPA with modern signed-by keyring
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/helix-ppa.gpg] https://ppa.launchpadcontent.net/maveonair/helix-editor/ubuntu {{ ansible_distribution_release
      }} main"
    filename: helix-ppa
    state: present
  become: true
  when: app_states.helix | default('present') == 'present'

- name: Install Helix editor
  ansible.builtin.apt:
    name: helix
    state: "{{ app_states.helix | default('present') }}"
    update_cache: true
  become: true

# Install language servers and tools
# Note: gopls requires Go to be installed (system/go role)
# Note: yaml-language-server requires Node.js/npm (system/nodejs role)
- name: Install Go language server (gopls)
  ansible.builtin.shell: |
    /usr/local/go/bin/go install golang.org/x/tools/gopls@latest
  become: true
  become_user: "{{ user.name }}"
  when: app_states.helix | default('present') == 'present'
  failed_when: false
  changed_when: false

- name: Check if npm is available
  ansible.builtin.command: which npm
  register: npm_check
  failed_when: false
  changed_when: false
  when: app_states.helix | default('present') == 'present'

- name: Install YAML language server via npm
  ansible.builtin.shell: |
    npm install -g yaml-language-server
  become: true
  when:
    - app_states.helix | default('present') == 'present'
    - npm_check.rc == 0
  failed_when: false
  changed_when: false

- name: Install Marksman (Markdown LSP)
  ansible.builtin.get_url:
    url: "https://github.com/artempyanykh/marksman/releases/latest/download/marksman-linux-x64"
    dest: "/usr/local/bin/marksman"
    mode: "0755"
  become: true
  when: app_states.helix | default('present') == 'present'
  failed_when: false

# Create Helix configuration directory
- name: Create Helix config directory
  ansible.builtin.file:
    path: "{{ user.home }}/.config/helix"
    state: directory
    owner: "{{ user.name }}"
    mode: "0755"
  when: app_states.helix | default('present') == 'present'

- name: Create Helix themes directory
  ansible.builtin.file:
    path: "{{ user.home }}/.config/helix/themes"
    state: directory
    owner: "{{ user.name }}"
    mode: "0755"
  when: app_states.helix | default('present') == 'present'

# Deploy Helix configuration files
- name: Deploy Helix config.toml
  ansible.builtin.template:
    src: config.toml.j2
    dest: "{{ user.home }}/.config/helix/config.toml"
    owner: "{{ user.name }}"
    mode: "0644"
  when: app_states.helix | default('present') == 'present'

- name: Deploy Helix languages.toml
  ansible.builtin.template:
    src: languages.toml.j2
    dest: "{{ user.home }}/.config/helix/languages.toml"
    owner: "{{ user.name }}"
    mode: "0644"
  when: app_states.helix | default('present') == 'present'

- name: Deploy custom COSMIC theme
  ansible.builtin.template:
    src: cosmic-term16.toml.j2
    dest: "{{ user.home }}/.config/helix/themes/cosmic-term16.toml"
    owner: "{{ user.name }}"
    mode: "0644"
  when: app_states.helix | default('present') == 'present'

# Set Helix as default editor
- name: Set EDITOR environment variable for Helix
  ansible.builtin.lineinfile:
    path: "{{ user.home }}/.profile"
    line: "export EDITOR=hx"
    create: true
    owner: "{{ user.name }}"
    mode: "0644"
  when: app_states.helix | default('present') == 'present'

# Cleanup when absent
- name: Remove Helix configuration when absent
  ansible.builtin.file:
    path: "{{ user.home }}/.config/helix"
    state: absent
  when: app_states.helix | default('present') == 'absent'

- name: Remove Helix PPA when absent
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/helix-ppa.gpg] https://ppa.launchpadcontent.net/maveonair/helix-editor/ubuntu {{ ansible_distribution_release
      }} main"
    filename: helix-ppa
    state: absent
  become: true
  when: app_states.helix | default('present') == 'absent'

- name: Remove Helix GPG key when absent
  ansible.builtin.file:
    path: /usr/share/keyrings/helix-ppa.gpg
    state: absent
  become: true
  when: app_states.helix | default('present') == 'absent'

- name: Remove EDITOR variable when absent
  ansible.builtin.lineinfile:
    path: "{{ user.home }}/.profile"
    line: "export EDITOR=hx"
    state: absent
  when: app_states.helix | default('present') == 'absent'

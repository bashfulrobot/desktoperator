---
# Vivaldi Browser installation via APT repository

- name: Add Vivaldi GPG key
  ansible.builtin.get_url:
    url: https://repo.vivaldi.com/archive/linux_signing_key.pub
    dest: /tmp/vivaldi-signing-key.pub
    mode: "0644"
  when: app_states['vivaldi'] | default('present') == 'present'

- name: Import Vivaldi GPG key
  ansible.builtin.shell: |
    gpg --dearmor < /tmp/vivaldi-signing-key.pub > /usr/share/keyrings/vivaldi.gpg
  args:
    creates: /usr/share/keyrings/vivaldi.gpg
  become: true
  when: app_states['vivaldi'] | default('present') == 'present'

- name: Add Vivaldi APT repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/vivaldi.gpg] https://repo.vivaldi.com/archive/deb/ stable main"
    filename: vivaldi
    state: present
  become: true
  when: app_states['vivaldi'] | default('present') == 'present'

- name: Update APT cache
  ansible.builtin.apt:
    update_cache: true
  become: true
  when: app_states['vivaldi'] | default('present') == 'present'

- name: Install Vivaldi browser
  ansible.builtin.apt:
    name: vivaldi-stable
    state: present
  become: true
  when: app_states['vivaldi'] | default('present') == 'present'

- name: Clean up GPG key file
  ansible.builtin.file:
    path: /tmp/vivaldi-signing-key.pub
    state: absent
  when: app_states['vivaldi'] | default('present') == 'present'

# 1Password Integration for Vivaldi Browser
- name: Create 1Password config directory
  ansible.builtin.file:
    path: /etc/1password
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true
  when: app_states['vivaldi'] | default('present') == 'present'

- name: Add Vivaldi to 1Password allowed browsers
  ansible.builtin.lineinfile:
    path: /etc/1password/custom_allowed_browsers
    line: vivaldi
    create: true
    owner: root
    group: root
    mode: "0755"
  become: true
  when: app_states['vivaldi'] | default('present') == 'present'

- name: Add Vivaldi-stable to 1Password allowed browsers
  ansible.builtin.lineinfile:
    path: /etc/1password/custom_allowed_browsers
    line: vivaldi-stable
    create: true
    owner: root
    group: root
    mode: "0755"
  become: true
  when: app_states['vivaldi'] | default('present') == 'present'

- name: Add Vivaldi-bin to 1Password allowed browsers
  ansible.builtin.lineinfile:
    path: /etc/1password/custom_allowed_browsers
    line: vivaldi-bin
    create: true
    owner: root
    group: root
    mode: "0755"
  become: true
  when: app_states['vivaldi'] | default('present') == 'present'

- name: Deploy Vivaldi command-line flags configuration
  ansible.builtin.template:
    src: vivaldi-stable.conf.j2
    dest: "{{ user.home }}/.config/vivaldi-stable.conf"
    owner: "{{ user.name }}"
    mode: "0644"
  when: app_states['vivaldi'] | default('present') == 'present'

# Generate COSMIC themes for Vivaldi (both Dark and Light)
# Theme ZIP files are generated manually with: just generate-theme-files
# Ansible only checks that they exist

- name: Check if Vivaldi theme ZIP files exist
  ansible.builtin.stat:
    path: "{{ playbook_dir }}/extras/themes/vivaldi/{{ item }}"
  register: vivaldi_zip_files
  loop:
    - cosmic-dark.zip
    - cosmic-light.zip
  delegate_to: localhost
  become: false

- name: Generate Vivaldi themes if missing
  ansible.builtin.command: "{{ playbook_dir }}/scripts/generate-vivaldi-themes.sh"
  args:
    chdir: "{{ playbook_dir }}"
  delegate_to: localhost
  become: false
  when:
    - app_states['vivaldi'] | default('present') == 'present'
    - vivaldi_zip_files.results | selectattr('stat.exists', 'equalto', false) | list | length > 0

# Cleanup when absent
- name: Remove Vivaldi browser when absent
  ansible.builtin.apt:
    name: vivaldi-stable
    state: absent
    purge: true
  become: true
  when: app_states['vivaldi'] | default('present') == 'absent'

- name: Remove Vivaldi repository when absent
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/vivaldi.gpg] https://repo.vivaldi.com/archive/deb/ stable main"
    filename: vivaldi
    state: absent
  become: true
  when: app_states['vivaldi'] | default('present') == 'absent'

- name: Remove Vivaldi GPG key when absent
  ansible.builtin.file:
    path: /usr/share/keyrings/vivaldi.gpg
    state: absent
  become: true
  when: app_states['vivaldi'] | default('present') == 'absent'

- name: Remove Vivaldi from 1Password allowed browsers when absent
  ansible.builtin.lineinfile:
    path: /etc/1password/custom_allowed_browsers
    line: vivaldi
    state: absent
  become: true
  when: app_states['vivaldi'] | default('present') == 'absent'
  failed_when: false

- name: Remove Vivaldi-stable from 1Password allowed browsers when absent
  ansible.builtin.lineinfile:
    path: /etc/1password/custom_allowed_browsers
    line: vivaldi-stable
    state: absent
  become: true
  when: app_states['vivaldi'] | default('present') == 'absent'
  failed_when: false

- name: Remove Vivaldi-bin from 1Password allowed browsers when absent
  ansible.builtin.lineinfile:
    path: /etc/1password/custom_allowed_browsers
    line: vivaldi-bin
    state: absent
  become: true
  when: app_states['vivaldi'] | default('present') == 'absent'
  failed_when: false

- name: Remove Vivaldi configuration file when absent
  ansible.builtin.file:
    path: "{{ user.home }}/.config/vivaldi-stable.conf"
    state: absent
  when: app_states['vivaldi'] | default('present') == 'absent'

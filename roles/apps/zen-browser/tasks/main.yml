---
# Zen Browser installation via GitHub releases (native, for 1Password integration)

- name: Check current Zen Browser version
  ansible.builtin.shell: |
    set -o pipefail
    if [ -f /opt/zen/zen ]; then
      /opt/zen/zen --version | grep -oP 'Zen Browser \K[0-9]+\.[0-9]+\.[0-9]+[a-z]?' || echo "unknown"
    else
      echo "not_installed"
    fi
  register: zen_current_version
  changed_when: false
  failed_when: false
  when: app_states['zen-browser'] | default('present') == 'present'

- name: Get latest Zen Browser release info
  ansible.builtin.uri:
    url: https://api.github.com/repos/zen-browser/desktop/releases/latest
    return_content: true
  register: zen_release_info
  when: app_states['zen-browser'] | default('present') == 'present'

- name: Set Zen Browser version facts
  ansible.builtin.set_fact:
    zen_latest_version: "{{ zen_release_info.json.tag_name }}"
    zen_needs_update: "{{ zen_current_version.stdout == 'not_installed' or zen_current_version.stdout != zen_release_info.json.tag_name }}"
  when: app_states['zen-browser'] | default('present') == 'present'

- name: Download Zen Browser tarball
  ansible.builtin.get_url:
    url: "https://github.com/zen-browser/desktop/releases/download/{{ zen_latest_version }}/zen.linux-x86_64.tar.xz"
    dest: "/tmp/zen-{{ zen_latest_version }}.tar.xz"
    mode: "0644"
  when:
    - app_states['zen-browser'] | default('present') == 'present'
    - zen_needs_update | bool
  become: true

- name: Remove old Zen Browser installation
  ansible.builtin.file:
    path: /opt/zen
    state: absent
  become: true
  when:
    - app_states['zen-browser'] | default('present') == 'present'
    - zen_needs_update | bool

- name: Extract Zen Browser tarball
  ansible.builtin.unarchive:
    src: "/tmp/zen-{{ zen_latest_version }}.tar.xz"
    dest: /opt
    remote_src: true
    owner: root
    group: root
  become: true
  when:
    - app_states['zen-browser'] | default('present') == 'present'
    - zen_needs_update | bool
  tags: zen-browser

- name: Create Zen Browser desktop entry
  ansible.builtin.copy:
    dest: /usr/share/applications/zen-browser.desktop
    mode: "0644"
    content: |
      [Desktop Entry]
      Version=1.0
      Name=Zen Browser
      Comment=Experience tranquillity while browsing the web
      Exec=/opt/zen/zen %u
      Icon=/opt/zen/browser/chrome/icons/default/default128.png
      Terminal=false
      Type=Application
      Categories=Network;WebBrowser;
      MimeType=text/html;text/xml;application/xhtml+xml;application/xml;application/vnd.mozilla.xul+xml;application/rss+xml;application/rdf+xml;x-scheme-handler/http;x-scheme-handler/https;
      StartupNotify=true
      StartupWMClass=zen
  become: true
  when: app_states['zen-browser'] | default('present') == 'present'

- name: Create Zen Browser symlink
  ansible.builtin.file:
    src: /opt/zen/zen
    dest: /usr/local/bin/zen
    state: link
  become: true
  when: app_states['zen-browser'] | default('present') == 'present'

- name: Clean up downloaded tarball
  ansible.builtin.file:
    path: "/tmp/zen-{{ zen_latest_version }}.tar.xz"
    state: absent
  when:
    - app_states['zen-browser'] | default('present') == 'present'
    - zen_needs_update | bool
  become: true

# 1Password Integration for Zen Browser
- name: Create 1Password config directory
  ansible.builtin.file:
    path: /etc/1password
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true
  when: app_states['zen-browser'] | default('present') == 'present'

- name: Add Zen Browser to 1Password allowed browsers
  ansible.builtin.blockinfile:
    path: /etc/1password/custom_allowed_browsers
    block: |
      zen
      zen-bin
    create: true
    owner: root
    group: root
    mode: "0755"
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Zen Browser"
  become: true
  when: app_states['zen-browser'] | default('present') == 'present'

# Cleanup when absent
- name: Remove Zen Browser symlink when absent
  ansible.builtin.file:
    path: /usr/local/bin/zen
    state: absent
  become: true
  when: app_states['zen-browser'] | default('present') == 'absent'

- name: Remove Zen Browser desktop entry when absent
  ansible.builtin.file:
    path: /usr/share/applications/zen-browser.desktop
    state: absent
  become: true
  when: app_states['zen-browser'] | default('present') == 'absent'

- name: Remove Zen Browser installation when absent
  ansible.builtin.file:
    path: /opt/zen
    state: absent
  become: true
  when: app_states['zen-browser'] | default('present') == 'absent'

- name: Remove Zen Browser from 1Password allowed browsers when absent
  ansible.builtin.blockinfile:
    path: /etc/1password/custom_allowed_browsers
    block: ""
    state: absent
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Zen Browser"
  become: true
  when: app_states['zen-browser'] | default('present') == 'absent'
  failed_when: false

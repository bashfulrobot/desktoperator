---
# Zen Browser installation via PPA (native, for 1Password integration)

- name: Add Zen Browser PPA GPG key
  apt_key:
    keyserver: keyserver.ubuntu.com
    id: A465A356660456511E9825F26495C5D30FF72029
    state: present
  become: yes
  when: app_states['zen-browser'] | default('present') == 'present'

- name: Add Zen Browser PPA repository
  apt_repository:
    repo: 'ppa:bashfulrobot/zen-browser'
    state: present
    update_cache: yes
  become: yes
  when: app_states['zen-browser'] | default('present') == 'present'

- name: Remove old manual Zen Browser installation
  file:
    path: /opt/zen
    state: absent
  become: yes
  when: app_states['zen-browser'] | default('present') == 'present'

- name: Remove old Zen Browser symlink
  file:
    path: /usr/local/bin/zen
    state: absent
  become: yes
  when: app_states['zen-browser'] | default('present') == 'present'

- name: Install Zen Browser from PPA
  apt:
    name: zen-browser
    state: latest
    update_cache: yes
  become: yes
  when: app_states['zen-browser'] | default('present') == 'present'
  tags: zen-browser

# 1Password Integration for Zen Browser
- name: Create 1Password config directory
  file:
    path: /etc/1password
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes
  when: app_states['zen-browser'] | default('present') == 'present'

- name: Add Zen Browser to 1Password allowed browsers
  blockinfile:
    path: /etc/1password/custom_allowed_browsers
    block: |
      zen
      zen-bin
    create: yes
    owner: root
    group: root
    mode: '0755'
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Zen Browser"
  become: yes
  when: app_states['zen-browser'] | default('present') == 'present'

# Cleanup when absent
- name: Remove Zen Browser package when absent
  apt:
    name: zen-browser
    state: absent
    purge: yes
  become: yes
  when: app_states['zen-browser'] | default('present') == 'absent'

- name: Remove Zen Browser PPA repository when absent
  apt_repository:
    repo: 'ppa:bashfulrobot/zen-browser'
    state: absent
    update_cache: yes
  become: yes
  when: app_states['zen-browser'] | default('present') == 'absent'

- name: Remove Zen Browser PPA GPG key when absent
  apt_key:
    id: A465A356660456511E9825F26495C5D30FF72029
    state: absent
  become: yes
  when: app_states['zen-browser'] | default('present') == 'absent'

- name: Remove old manual installation when absent
  file:
    path: /opt/zen
    state: absent
  become: yes
  when: app_states['zen-browser'] | default('present') == 'absent'

- name: Remove old Zen Browser symlink when absent
  file:
    path: /usr/local/bin/zen
    state: absent
  become: yes
  when: app_states['zen-browser'] | default('present') == 'absent'

- name: Remove Zen Browser from 1Password allowed browsers when absent
  blockinfile:
    path: /etc/1password/custom_allowed_browsers
    block: ""
    state: absent
    marker: "# {mark} ANSIBLE MANAGED BLOCK - Zen Browser"
  become: yes
  when: app_states['zen-browser'] | default('present') == 'absent'
  failed_when: false

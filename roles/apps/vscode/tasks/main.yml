---
# Visual Studio Code installation via official Microsoft repository

# Ensure color variables exist (auto-generate if missing)
- name: Check if auto-colors.yml exists
  stat:
    path: "{{ playbook_dir }}/group_vars/all/auto-colors.yml"
  register: auto_colors_file
  delegate_to: localhost
  become: no

- name: Generate color variables if missing
  command: "{{ playbook_dir }}/scripts/generate-cosmic-colors.sh"
  args:
    chdir: "{{ playbook_dir }}"
  delegate_to: localhost
  become: no
  when:
    - not auto_colors_file.stat.exists
    - app_states['vscode'] | default('present') == 'present'

- name: Load auto-generated color variables
  include_vars:
    file: "{{ playbook_dir }}/group_vars/all/auto-colors.yml"
  when: app_states['vscode'] | default('present') == 'present'

- name: Install dependencies for VSCode
  apt:
    name:
      - wget
      - gpg
      - apt-transport-https
    state: present
  become: yes
  when: app_states['vscode'] | default('present') == 'present'

- name: Remove conflicting VSCode repository files
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /etc/apt/sources.list.d/vscode.list
    - /etc/apt/sources.list.d/vscode.sources
  become: yes
  when: app_states['vscode'] | default('present') == 'present'

- name: Remove conflicting Microsoft GPG keys
  file:
    path: "{{ item }}"
    state: absent
  loop:
    - /usr/share/keyrings/microsoft.gpg
    - /etc/apt/trusted.gpg.d/microsoft.gpg
  become: yes
  when: app_states['vscode'] | default('present') == 'present'

- name: Download Microsoft GPG key
  get_url:
    url: https://packages.microsoft.com/keys/microsoft.asc
    dest: /tmp/microsoft.asc
    mode: '0644'
  become: yes
  when: app_states['vscode'] | default('present') == 'present'

- name: Add Microsoft GPG key to keyrings
  shell: |
    gpg --dearmor < /tmp/microsoft.asc > /usr/share/keyrings/packages.microsoft.gpg
    chmod 644 /usr/share/keyrings/packages.microsoft.gpg
  args:
    creates: /usr/share/keyrings/packages.microsoft.gpg
  become: yes
  when: app_states['vscode'] | default('present') == 'present'

- name: Clean up temporary GPG key file
  file:
    path: /tmp/microsoft.asc
    state: absent
  become: yes
  when: app_states['vscode'] | default('present') == 'present'

- name: Add VSCode repository
  apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main"
    filename: vscode
    state: present
  become: yes
  when: app_states['vscode'] | default('present') == 'present'

- name: Flush handlers to ensure apt cache is updated
  meta: flush_handlers

- name: Install Visual Studio Code
  apt:
    name: code
    state: "{{ app_states['vscode'] | default('present') }}"
    update_cache: yes
  become: yes

# Install high-resolution icon in proper icon theme directory
# VSCode package installs 1024x1024 PNG to pixmaps, copy to hicolor theme
- name: Ensure hicolor 1024x1024 apps directory exists
  file:
    path: /usr/share/icons/hicolor/1024x1024/apps
    state: directory
    mode: '0755'
  become: yes
  when: app_states['vscode'] | default('present') == 'present'

- name: Copy VSCode icon to hicolor theme directory (1024x1024)
  copy:
    src: /usr/share/pixmaps/vscode.png
    dest: /usr/share/icons/hicolor/1024x1024/apps/vscode.png
    remote_src: yes
    mode: '0644'
  become: yes
  when: app_states['vscode'] | default('present') == 'present'

- name: Update icon cache for VSCode
  command: gtk-update-icon-cache -f -t /usr/share/icons/hicolor
  become: yes
  when: app_states['vscode'] | default('present') == 'present'
  ignore_errors: yes

# Fix keyring access on COSMIC Desktop (Chromium doesn't recognize COSMIC)
# Force VSCode to use gnome-libsecret for password storage + Wayland optimizations
- name: Create VSCode config directory
  file:
    path: "{{ user.home }}/.config/Code/User"
    state: directory
    owner: "{{ user.name }}"
    mode: '0755'
  when: app_states['vscode'] | default('present') == 'present'

- name: Create .vscode directory for argv.json
  file:
    path: "{{ user.home }}/.vscode"
    state: directory
    owner: "{{ user.name }}"
    mode: '0755'
  when: app_states['vscode'] | default('present') == 'present'

- name: Configure VSCode runtime arguments (argv.json)
  copy:
    content: |
      // This configuration file allows you to pass permanent command line arguments to VS Code.
      // Only a subset of arguments is currently supported to reduce the likelihood of breaking
      // the installation.
      //
      // PLEASE DO NOT CHANGE WITHOUT UNDERSTANDING THE IMPACT
      //
      // NOTE: Changing this file requires a restart of VS Code.
      {
        // Use software rendering instead of hardware accelerated rendering.
        // This can help in cases where you see rendering issues in VS Code.
        // "disable-hardware-acceleration": true,

        // Allows to disable crash reporting.
        // Should restart the app if the value is changed.
        "enable-crash-reporter": true,

        // Unique id used for correlating crash reports sent from this instance.
        // Do not edit this value.
        "crash-reporter-id": "{{ vscode_crash_reporter_id | default('e0987853-1544-4130-8f49-b10d7689f378') }}",

        // COSMIC Desktop compatibility - use GNOME keyring for password storage
        "password-store": "gnome-libsecret"
      }
    dest: "{{ user.home }}/.vscode/argv.json"
    owner: "{{ user.name }}"
    mode: '0644'
  when: app_states['vscode'] | default('present') == 'present'

- name: Configure VSCode Wayland flags (code-flags.conf)
  copy:
    content: |
      --enable-features=UseOzonePlatform,WaylandWindowDecorations
      --ozone-platform=wayland
    dest: "{{ user.home }}/.config/code-flags.conf"
    owner: "{{ user.name }}"
    mode: '0644'
  when: app_states['vscode'] | default('present') == 'present'

# COSMIC Theme Integration
# Theme VSIX files are generated manually with: just generate-theme-files
# Ansible only checks that they exist

- name: Check if VSCode theme VSIX files exist
  stat:
    path: "{{ playbook_dir }}/extras/themes/vscode/{{ item }}"
  register: vscode_vsix_files
  loop:
    - cosmic-theme-dark.vsix
    - cosmic-theme-light.vsix
  delegate_to: localhost
  become: no

- name: Generate VSCode themes if missing
  command: "{{ playbook_dir }}/scripts/generate-vscode-themes.sh"
  args:
    chdir: "{{ playbook_dir }}"
  delegate_to: localhost
  become: no
  when:
    - app_states['vscode'] | default('present') == 'present'
    - vscode_vsix_files.results | selectattr('stat.exists', 'equalto', false) | list | length > 0

# Install vsce globally for packaging VSCode extensions (needed by generation script)
- name: Install vsce globally via npm
  shell: npm install -g @vscode/vsce
  become: yes
  when: app_states['vscode'] | default('present') == 'present'
  register: vsce_install
  failed_when: false
  changed_when: vsce_install.rc == 0

# Cleanup when absent
- name: Remove VSCode repository when absent
  apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/packages.microsoft.gpg] https://packages.microsoft.com/repos/code stable main"
    filename: vscode
    state: absent
  become: yes
  when: app_states['vscode'] | default('present') == 'absent'

- name: Remove Microsoft GPG key when absent
  file:
    path: /usr/share/keyrings/packages.microsoft.gpg
    state: absent
  become: yes
  when: app_states['vscode'] | default('present') == 'absent'

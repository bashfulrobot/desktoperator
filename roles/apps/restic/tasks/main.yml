---
# Restic and Autorestic installation and configuration

- name: Install restic from apt
  ansible.builtin.apt:
    name: restic
    state: "{{ app_states.restic | default('present') }}"
  become: true

- name: Check if autorestic is installed
  ansible.builtin.stat:
    path: /usr/local/bin/autorestic
  register: autorestic_installed

- name: Download autorestic installation script
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/cupcakearmy/autorestic/master/install.sh
    dest: /tmp/autorestic-install.sh
    mode: "0755"
  when:
    - not autorestic_installed.stat.exists
    - app_states.restic | default('present') == 'present'

- name: Install autorestic
  ansible.builtin.command: bash /tmp/autorestic-install.sh
  args:
    creates: ./autorestic
  when:
    - not autorestic_installed.stat.exists
    - app_states.restic | default('present') == 'present'
  register: autorestic_download

- name: Move autorestic to /usr/local/bin
  ansible.builtin.copy:
    src: "{{ ansible_env.PWD }}/autorestic"
    dest: /usr/local/bin/autorestic
    mode: "0755"
    remote_src: true
  become: true
  when:
    - autorestic_download is defined
    - autorestic_download.changed

- name: Remove installation script and downloaded binary
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/autorestic-install.sh
    - "{{ ansible_env.PWD }}/autorestic"
  when:
    - autorestic_download is defined
    - autorestic_download.changed

# Configuration deployment (when present)
- name: Create autorestic config directory
  ansible.builtin.file:
    path: "{{ user.home }}/.config/autorestic"
    state: directory
    owner: "{{ user.name }}"
    mode: "0755"
  when: app_states.restic | default('present') == 'present'

- name: Deploy autorestic configuration
  ansible.builtin.template:
    src: autorestic.yml.j2
    dest: "{{ user.home }}/.config/autorestic/autorestic.yml"
    owner: "{{ user.name }}"
    mode: "0600"
  when: app_states.restic | default('present') == 'present'

- name: Deploy autorestic exclude file
  ansible.builtin.template:
    src: autorestic-exclude.j2
    dest: "{{ user.home }}/.config/autorestic/exclude"
    owner: "{{ user.name }}"
    mode: "0644"
  when: app_states.restic | default('present') == 'present'

- name: Create autorestic log directory
  ansible.builtin.file:
    path: "{{ user.home }}/.local/share/autorestic"
    state: directory
    owner: "{{ user.name }}"
    mode: "0755"
  when: app_states.restic | default('present') == 'present'

# Deploy convenience scripts
- name: Deploy restic convenience scripts
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: /usr/local/bin/{{ item }}
    mode: "0755"
  become: true
  loop:
    - restic-backup
    - restic-restore
    - restic-status
    - restic-list-files
    - restic-init
  when: app_states.restic | default('present') == 'present'

# Systemd service and timer (user-level)
- name: Get user UID
  ansible.builtin.command: id -u {{ user.name }}
  register: user_uid_result
  changed_when: false
  when: app_states.restic | default('present') == 'present'

- name: Create systemd user directory
  ansible.builtin.file:
    path: "{{ user.home }}/.config/systemd/user"
    state: directory
    owner: "{{ user.name }}"
    mode: "0755"
  when: app_states.restic | default('present') == 'present'

- name: Deploy systemd service unit
  ansible.builtin.template:
    src: autorestic-backup.service.j2
    dest: "{{ user.home }}/.config/systemd/user/autorestic-backup.service"
    owner: "{{ user.name }}"
    mode: "0644"
  when: app_states.restic | default('present') == 'present'
  register: systemd_service

- name: Deploy systemd timer unit
  ansible.builtin.template:
    src: autorestic-backup.timer.j2
    dest: "{{ user.home }}/.config/systemd/user/autorestic-backup.timer"
    owner: "{{ user.name }}"
    mode: "0644"
  when: app_states.restic | default('present') == 'present'
  register: systemd_timer

- name: Reload systemd user daemon
  ansible.builtin.systemd:
    daemon_reload: true
    scope: user
  become: true
  become_user: "{{ user.name }}"
  when:
    - app_states.restic | default('present') == 'present'
    - systemd_service.changed or systemd_timer.changed
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ user_uid_result.stdout }}"

- name: Enable and start autorestic timer
  ansible.builtin.systemd:
    name: autorestic-backup.timer
    enabled: true
    state: started
    scope: user
  become: true
  become_user: "{{ user.name }}"
  when: app_states.restic | default('present') == 'present'
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ user_uid_result.stdout }}"

# Cleanup when state is absent
- name: Get user UID for cleanup
  ansible.builtin.command: id -u {{ user.name }}
  register: user_uid_cleanup
  changed_when: false
  when: app_states.restic | default('present') == 'absent'

- name: Stop and disable autorestic timer when state is absent
  ansible.builtin.systemd:
    name: autorestic-backup.timer
    enabled: false
    state: stopped
    scope: user
  become: true
  become_user: "{{ user.name }}"
  when: app_states.restic | default('present') == 'absent'
  environment:
    XDG_RUNTIME_DIR: "/run/user/{{ user_uid_cleanup.stdout }}"
  failed_when: false

- name: Remove systemd units when state is absent
  ansible.builtin.file:
    path: "{{ user.home }}/.config/systemd/user/{{ item }}"
    state: absent
  loop:
    - autorestic-backup.service
    - autorestic-backup.timer
  when: app_states.restic | default('present') == 'absent'

- name: Remove autorestic when state is absent
  ansible.builtin.file:
    path: /usr/local/bin/autorestic
    state: absent
  become: true
  when: app_states.restic | default('present') == 'absent'

- name: Remove autorestic configuration when state is absent
  ansible.builtin.file:
    path: "{{ user.home }}/.config/autorestic"
    state: absent
  when: app_states.restic | default('present') == 'absent'

- name: Remove restic scripts when state is absent
  ansible.builtin.file:
    path: /usr/local/bin/{{ item }}
    state: absent
  become: true
  loop:
    - restic-backup
    - restic-restore
    - restic-status
    - restic-list-files
    - restic-init
  when: app_states.restic | default('present') == 'absent'

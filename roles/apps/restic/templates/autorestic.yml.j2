---
# Autorestic configuration
# Generated by Ansible - do not edit manually

version: 2

backends:
  b2:
    type: s3
    path: '{{ b2_repository }}/{{ restic.folder_name }}'
    key: '{{ restic_password }}'
    env:
      AWS_ACCESS_KEY_ID: '{{ b2_account_id }}'
      AWS_SECRET_ACCESS_KEY: '{{ b2_account_key }}'

{% if restic.local_backup.enable %}
  local:
    type: local
    path: '{{ restic.local_backup.path }}/{{ restic.folder_name }}'
    key: '{{ restic_password }}'
{% endif %}

locations:
  home:
    from: '{{ user.home }}'
    to:
      - b2
{% if restic.local_backup.enable %}
      - local
{% endif %}

    cron: '{{ restic.schedule }}'

    options:
      backup:
        exclude-file:
          - '{{ user.home }}/.config/autorestic/exclude'

      forget:
        keep-last: {{ restic.retention_policy.keep_last }}
        keep-hourly: {{ restic.retention_policy.keep_hourly }}
        keep-daily: {{ restic.retention_policy.keep_daily }}
        keep-weekly: {{ restic.retention_policy.keep_weekly }}
        keep-monthly: {{ restic.retention_policy.keep_monthly }}
        keep-yearly: {{ restic.retention_policy.keep_yearly }}

    hooks:
      success:
        - 'echo "$(date): Backup completed successfully" >> {{ user.home }}/.local/share/autorestic/backup.log'

      failure:
        - 'echo "$(date): Backup FAILED" >> {{ user.home }}/.local/share/autorestic/backup-failures.log'
        - 'notify-send -u critical "Restic Backup Failed" "Check logs for details"'

---
# Spotify installation
# Official Spotify client via APT repository
# ncspot terminal client via Flatpak

# Official Spotify client installation
- name: Download Spotify GPG key
  ansible.builtin.get_url:
    url: https://download.spotify.com/debian/pubkey_C85668DF69375001.gpg
    dest: /tmp/spotify.gpg
    mode: "0644"
  when: app_states['spotify'] | default('present') == 'present'

- name: Add Spotify GPG key to trusted keyring
  ansible.builtin.shell: |
    gpg --dearmor < /tmp/spotify.gpg > /etc/apt/trusted.gpg.d/spotify.gpg
    chmod 644 /etc/apt/trusted.gpg.d/spotify.gpg
  args:
    creates: /etc/apt/trusted.gpg.d/spotify.gpg
  become: true
  when: app_states['spotify'] | default('present') == 'present'

- name: Clean up temporary Spotify GPG key file
  ansible.builtin.file:
    path: /tmp/spotify.gpg
    state: absent
  when: app_states['spotify'] | default('present') == 'present'

# Explicitly specify arch=amd64 to prevent i386 package lookup warnings
# For ARM support, change arch=amd64 to arch=amd64,arm64
- name: Add Spotify APT repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64] https://repository.spotify.com stable non-free"
    filename: spotify
    state: present
  become: true
  when: app_states['spotify'] | default('present') == 'present'

- name: Update APT cache
  ansible.builtin.apt:
    update_cache: true
  become: true
  when: app_states['spotify'] | default('present') == 'present'

- name: Install Spotify client
  ansible.builtin.apt:
    name: spotify-client
    state: present
  become: true
  when: app_states['spotify'] | default('present') == 'present'

# ncspot terminal client installation (GitHub release)
- name: Install ncspot runtime dependencies
  ansible.builtin.apt:
    name:
      - dbus                # D-Bus system
      - libdbus-1-3         # D-Bus library for MPRIS support
      - libncursesw6        # NCurses library (wide character support)
      - libssl3t64          # SSL library (time64 variant for Ubuntu 24.04)
      - libpulse0           # PulseAudio client library
      - libxcb1             # X11 clipboard support
      - ueberzug            # Album cover art display
      - netcat-openbsd      # For IPC socket communication with -W flag
      - jq                  # For JSON parsing
      - curl                # For downloading album art
      - libnotify-bin       # For desktop notifications
    state: present
  become: true
  when: app_states['spotify'] | default('present') == 'present'

- name: Create ncspot installation directory
  ansible.builtin.file:
    path: "{{ ncspot_install_dir }}"
    state: directory
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0755"
  when: app_states['spotify'] | default('present') == 'present'

- name: Download ncspot from GitHub releases
  ansible.builtin.get_url:
    url: "https://github.com/hrkfdn/ncspot/releases/download/{{ ncspot_version }}/ncspot-{{ ncspot_version }}-linux-{{ ncspot_arch }}.tar.gz"
    dest: "/tmp/ncspot-{{ ncspot_version }}-linux-{{ ncspot_arch }}.tar.gz"
    mode: "0644"
  when: app_states['spotify'] | default('present') == 'present'

- name: Extract ncspot binary
  ansible.builtin.unarchive:
    src: "/tmp/ncspot-{{ ncspot_version }}-linux-{{ ncspot_arch }}.tar.gz"
    dest: "{{ ncspot_install_dir }}"
    remote_src: true
    mode: "0755"
  when: app_states['spotify'] | default('present') == 'present'

- name: Clean up ncspot download
  ansible.builtin.file:
    path: "/tmp/ncspot-{{ ncspot_version }}-linux-{{ ncspot_arch }}.tar.gz"
    state: absent
  when: app_states['spotify'] | default('present') == 'present'

# ncspot configuration
- name: Create ncspot config directory
  ansible.builtin.file:
    path: "{{ user.home }}/.config/ncspot"
    state: directory
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0755"
  when: app_states['spotify'] | default('present') == 'present'

- name: Deploy ncspot configuration file
  ansible.builtin.template:
    src: config.toml.j2
    dest: "{{ user.home }}/.config/ncspot/config.toml"
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0644"
  when: app_states['spotify'] | default('present') == 'present'

# ncspot save script
- name: Create user bin directory
  ansible.builtin.file:
    path: "{{ user.home }}/.local/bin"
    state: directory
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0755"
  when: app_states['spotify'] | default('present') == 'present'

- name: Deploy ncspot-save script
  ansible.builtin.template:
    src: ncspot-save.sh.j2
    dest: "{{ user.home }}/.local/bin/ncspot-save"
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0755"
  when: app_states['spotify'] | default('present') == 'present'

- name: Deploy ncspot-session script
  ansible.builtin.template:
    src: ncspot-session.sh.j2
    dest: "{{ user.home }}/.local/bin/ncspot-session"
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0755"
  when: app_states['spotify'] | default('present') == 'present'

- name: Create zellij layouts directory
  ansible.builtin.file:
    path: "{{ user.home }}/.config/zellij/layouts"
    state: directory
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0755"
  when: app_states['spotify'] | default('present') == 'present'

- name: Deploy ncspot zellij layout
  ansible.builtin.template:
    src: ncspot-layout.kdl.j2
    dest: "{{ user.home }}/.config/zellij/layouts/ncspot.kdl"
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0644"
  when: app_states['spotify'] | default('present') == 'present'

# Fish shell integration
- name: Create fish conf.d directory
  ansible.builtin.file:
    path: "{{ user.home }}/.config/fish/conf.d"
    state: directory
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0755"
  when: app_states['spotify'] | default('present') == 'present'

- name: Deploy fish alias for ncspot
  ansible.builtin.template:
    src: ncspot.fish.j2
    dest: "{{ user.home }}/.config/fish/conf.d/ncspot.fish"
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0644"
  when: app_states['spotify'] | default('present') == 'present'

# Cleanup when absent
- name: Remove Spotify client when absent
  ansible.builtin.apt:
    name: spotify-client
    state: absent
    purge: true
  become: true
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove Spotify repository when absent
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64] https://repository.spotify.com stable non-free"
    filename: spotify
    state: absent
  become: true
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove Spotify GPG key when absent
  ansible.builtin.file:
    path: /etc/apt/trusted.gpg.d/spotify.gpg
    state: absent
  become: true
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove ncspot binary when absent
  ansible.builtin.file:
    path: "{{ ncspot_install_dir }}/ncspot"
    state: absent
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove fish alias for ncspot when absent
  ansible.builtin.file:
    path: "{{ user.home }}/.config/fish/conf.d/ncspot.fish"
    state: absent
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove ncspot configuration directory when absent
  ansible.builtin.file:
    path: "{{ user.home }}/.config/ncspot"
    state: absent
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove ncspot-save script when absent
  ansible.builtin.file:
    path: "{{ user.home }}/.local/bin/ncspot-save"
    state: absent
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove ncspot-session script when absent
  ansible.builtin.file:
    path: "{{ user.home }}/.local/bin/ncspot-session"
    state: absent
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove ncspot zellij layout when absent
  ansible.builtin.file:
    path: "{{ user.home }}/.config/zellij/layouts/ncspot.kdl"
    state: absent
  when: app_states['spotify'] | default('present') == 'absent'

# Migration: Clean up old Flatpak installation
- name: Remove old Flatpak ncspot installation (migration)
  community.general.flatpak:
    name: io.github.hrkfdn.ncspot
    state: absent
  become: true
  failed_when: false
  when: app_states['spotify'] | default('present') == 'present'

- name: Remove old Flatpak ncspot config (migration)
  ansible.builtin.file:
    path: "{{ user.home }}/.var/app/io.github.hrkfdn.ncspot/config/ncspot"
    state: absent
  failed_when: false
  when: app_states['spotify'] | default('present') == 'present'

---
# Spotify installation
# Official Spotify client via APT repository
# ncspot terminal client via Flatpak

# Official Spotify client installation
- name: Download Spotify GPG key
  ansible.builtin.get_url:
    url: https://download.spotify.com/debian/pubkey_C85668DF69375001.gpg
    dest: /tmp/spotify.gpg
    mode: "0644"
  when: app_states['spotify'] | default('present') == 'present'

- name: Add Spotify GPG key to trusted keyring
  ansible.builtin.shell: |
    gpg --dearmor < /tmp/spotify.gpg > /etc/apt/trusted.gpg.d/spotify.gpg
    chmod 644 /etc/apt/trusted.gpg.d/spotify.gpg
  args:
    creates: /etc/apt/trusted.gpg.d/spotify.gpg
  become: true
  when: app_states['spotify'] | default('present') == 'present'

- name: Clean up temporary Spotify GPG key file
  ansible.builtin.file:
    path: /tmp/spotify.gpg
    state: absent
  when: app_states['spotify'] | default('present') == 'present'

# Explicitly specify arch=amd64 to prevent i386 package lookup warnings
# For ARM support, change arch=amd64 to arch=amd64,arm64
- name: Add Spotify APT repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64] https://repository.spotify.com stable non-free"
    filename: spotify
    state: present
  become: true
  when: app_states['spotify'] | default('present') == 'present'

- name: Update APT cache
  ansible.builtin.apt:
    update_cache: true
  become: true
  when: app_states['spotify'] | default('present') == 'present'

- name: Install Spotify client
  ansible.builtin.apt:
    name: spotify-client
    state: present
  become: true
  when: app_states['spotify'] | default('present') == 'present'

# ncspot terminal client installation (Flatpak)
- name: Install ncspot terminal Spotify client
  community.general.flatpak:
    name: io.github.hrkfdn.ncspot
    state: present
    remote: flathub
  become: true
  when: app_states['spotify'] | default('present') == 'present'

# Cleanup when absent
- name: Remove Spotify client when absent
  ansible.builtin.apt:
    name: spotify-client
    state: absent
    purge: true
  become: true
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove Spotify repository when absent
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64] https://repository.spotify.com stable non-free"
    filename: spotify
    state: absent
  become: true
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove Spotify GPG key when absent
  ansible.builtin.file:
    path: /etc/apt/trusted.gpg.d/spotify.gpg
    state: absent
  become: true
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove ncspot when absent
  community.general.flatpak:
    name: io.github.hrkfdn.ncspot
    state: absent
  become: true
  when: app_states['spotify'] | default('present') == 'absent'

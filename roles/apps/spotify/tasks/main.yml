---
# Spotify installation
# Official Spotify client via APT repository
# ncspot terminal client via Flatpak

# Official Spotify client installation
- name: Download Spotify GPG key
  ansible.builtin.get_url:
    url: https://download.spotify.com/debian/pubkey_C85668DF69375001.gpg
    dest: /tmp/spotify.gpg
    mode: "0644"
  when: app_states['spotify'] | default('present') == 'present'

- name: Add Spotify GPG key to trusted keyring
  ansible.builtin.shell: |
    gpg --dearmor < /tmp/spotify.gpg > /etc/apt/trusted.gpg.d/spotify.gpg
    chmod 644 /etc/apt/trusted.gpg.d/spotify.gpg
  args:
    creates: /etc/apt/trusted.gpg.d/spotify.gpg
  become: true
  when: app_states['spotify'] | default('present') == 'present'

- name: Clean up temporary Spotify GPG key file
  ansible.builtin.file:
    path: /tmp/spotify.gpg
    state: absent
  when: app_states['spotify'] | default('present') == 'present'

# Explicitly specify arch=amd64 to prevent i386 package lookup warnings
# For ARM support, change arch=amd64 to arch=amd64,arm64
- name: Add Spotify APT repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64] https://repository.spotify.com stable non-free"
    filename: spotify
    state: present
  become: true
  when: app_states['spotify'] | default('present') == 'present'

- name: Update APT cache
  ansible.builtin.apt:
    update_cache: true
  become: true
  when: app_states['spotify'] | default('present') == 'present'

- name: Install Spotify client
  ansible.builtin.apt:
    name: spotify-client
    state: present
  become: true
  when: app_states['spotify'] | default('present') == 'present'

# ncspot terminal client installation (Flatpak)
- name: Install ncspot terminal Spotify client
  community.general.flatpak:
    name: io.github.hrkfdn.ncspot
    state: present
    remote: flathub
  become: true
  when: app_states['spotify'] | default('present') == 'present'

# ncspot dependencies for IPC scripting
- name: Install ncspot script dependencies
  ansible.builtin.apt:
    name:
      - netcat-openbsd  # For IPC socket communication with -W flag
      - jq              # For JSON parsing
      - curl            # For downloading album art
      - libnotify-bin   # For desktop notifications
    state: present
  become: true
  when: app_states['spotify'] | default('present') == 'present'

# ncspot configuration
- name: Create ncspot config directory
  ansible.builtin.file:
    path: "{{ user.home }}/.config/ncspot"
    state: directory
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0755"
  when: app_states['spotify'] | default('present') == 'present'

- name: Deploy ncspot configuration file
  ansible.builtin.template:
    src: config.toml.j2
    dest: "{{ user.home }}/.config/ncspot/config.toml"
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0644"
  when: app_states['spotify'] | default('present') == 'present'

# ncspot save script
- name: Create user bin directory
  ansible.builtin.file:
    path: "{{ user.home }}/.local/bin"
    state: directory
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0755"
  when: app_states['spotify'] | default('present') == 'present'

- name: Deploy ncspot-save script
  ansible.builtin.template:
    src: ncspot-save.sh.j2
    dest: "{{ user.home }}/.local/bin/ncspot-save"
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0755"
  when: app_states['spotify'] | default('present') == 'present'

# Fish shell integration
- name: Create fish conf.d directory
  ansible.builtin.file:
    path: "{{ user.home }}/.config/fish/conf.d"
    state: directory
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0755"
  when: app_states['spotify'] | default('present') == 'present'

- name: Deploy fish alias for ncspot
  ansible.builtin.template:
    src: ncspot.fish.j2
    dest: "{{ user.home }}/.config/fish/conf.d/ncspot.fish"
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: "0644"
  when: app_states['spotify'] | default('present') == 'present'

# Cleanup when absent
- name: Remove Spotify client when absent
  ansible.builtin.apt:
    name: spotify-client
    state: absent
    purge: true
  become: true
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove Spotify repository when absent
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64] https://repository.spotify.com stable non-free"
    filename: spotify
    state: absent
  become: true
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove Spotify GPG key when absent
  ansible.builtin.file:
    path: /etc/apt/trusted.gpg.d/spotify.gpg
    state: absent
  become: true
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove ncspot when absent
  community.general.flatpak:
    name: io.github.hrkfdn.ncspot
    state: absent
  become: true
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove fish alias for ncspot when absent
  ansible.builtin.file:
    path: "{{ user.home }}/.config/fish/conf.d/ncspot.fish"
    state: absent
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove ncspot configuration directory when absent
  ansible.builtin.file:
    path: "{{ user.home }}/.config/ncspot"
    state: absent
  when: app_states['spotify'] | default('present') == 'absent'

- name: Remove ncspot-save script when absent
  ansible.builtin.file:
    path: "{{ user.home }}/.local/bin/ncspot-save"
    state: absent
  when: app_states['spotify'] | default('present') == 'absent'

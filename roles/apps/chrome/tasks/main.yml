---
# Google Chrome installation via APT repository

- name: Add Google Chrome GPG key
  ansible.builtin.get_url:
    url: https://dl.google.com/linux/linux_signing_key.pub
    dest: /tmp/google-chrome-signing-key.pub
    mode: "0644"
  when: app_states['chrome'] | default('present') == 'present'

- name: Import Google Chrome GPG key
  ansible.builtin.shell: |
    gpg --dearmor < /tmp/google-chrome-signing-key.pub > /usr/share/keyrings/google-chrome.gpg
    chmod 644 /usr/share/keyrings/google-chrome.gpg
  args:
    creates: /usr/share/keyrings/google-chrome.gpg
  become: true
  when: app_states['chrome'] | default('present') == 'present'

# Remove old GPG key location if it exists
- name: Remove old Google Chrome GPG key from trusted.gpg.d
  ansible.builtin.file:
    path: /etc/apt/trusted.gpg.d/google-chrome.gpg
    state: absent
  become: true
  when: app_states['chrome'] | default('present') == 'present'

# Clean up old repository entries to prevent duplicates
- name: Remove old Google Chrome .list file entries without signed-by
  ansible.builtin.lineinfile:
    path: /etc/apt/sources.list.d/google-chrome.list
    regexp: "^deb \\[arch=amd64\\] https://dl\\.google\\.com/linux/chrome/deb/"
    state: absent
  become: true
  when: app_states['chrome'] | default('present') == 'present'
  failed_when: false

# Explicitly specify arch=amd64 to prevent i386 package lookup warnings
# For ARM support, change arch=amd64 to arch=amd64,arm64
- name: Add Google Chrome APT repository
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] https://dl.google.com/linux/chrome/deb/ stable main"
    filename: google-chrome
    state: present
  become: true
  when: app_states['chrome'] | default('present') == 'present'

- name: Update APT cache
  ansible.builtin.apt:
    update_cache: true
  become: true
  when: app_states['chrome'] | default('present') == 'present'

- name: Install Google Chrome
  ansible.builtin.apt:
    name: google-chrome-stable
    state: present
  become: true
  when: app_states['chrome'] | default('present') == 'present'

- name: Clean up GPG key file
  ansible.builtin.file:
    path: /tmp/google-chrome-signing-key.pub
    state: absent
  when: app_states['chrome'] | default('present') == 'present'

# 1Password Integration for Chrome
- name: Create 1Password config directory
  ansible.builtin.file:
    path: /etc/1password
    state: directory
    owner: root
    group: root
    mode: "0755"
  become: true
  when: app_states['chrome'] | default('present') == 'present'

- name: Add Chrome to 1Password allowed browsers
  ansible.builtin.lineinfile:
    path: /etc/1password/custom_allowed_browsers
    line: chrome
    create: true
    owner: root
    group: root
    mode: "0755"
  become: true
  when: app_states['chrome'] | default('present') == 'present'

- name: Add google-chrome to 1Password allowed browsers
  ansible.builtin.lineinfile:
    path: /etc/1password/custom_allowed_browsers
    line: google-chrome
    create: true
    owner: root
    group: root
    mode: "0755"
  become: true
  when: app_states['chrome'] | default('present') == 'present'

- name: Add google-chrome-stable to 1Password allowed browsers
  ansible.builtin.lineinfile:
    path: /etc/1password/custom_allowed_browsers
    line: google-chrome-stable
    create: true
    owner: root
    group: root
    mode: "0755"
  become: true
  when: app_states['chrome'] | default('present') == 'present'

# Cleanup when absent
- name: Remove Google Chrome when absent
  ansible.builtin.apt:
    name: google-chrome-stable
    state: absent
    purge: true
  become: true
  when: app_states['chrome'] | default('present') == 'absent'

- name: Remove Google Chrome repository when absent
  ansible.builtin.apt_repository:
    repo: "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] https://dl.google.com/linux/chrome/deb/ stable main"
    filename: google-chrome
    state: absent
  become: true
  when: app_states['chrome'] | default('present') == 'absent'

- name: Remove Google Chrome GPG key when absent
  ansible.builtin.file:
    path: /usr/share/keyrings/google-chrome.gpg
    state: absent
  become: true
  when: app_states['chrome'] | default('present') == 'absent'

- name: Remove old Google Chrome GPG key when absent
  ansible.builtin.file:
    path: /etc/apt/trusted.gpg.d/google-chrome.gpg
    state: absent
  become: true
  when: app_states['chrome'] | default('present') == 'absent'

- name: Remove Chrome from 1Password allowed browsers when absent
  ansible.builtin.lineinfile:
    path: /etc/1password/custom_allowed_browsers
    line: chrome
    state: absent
  become: true
  when: app_states['chrome'] | default('present') == 'absent'
  failed_when: false

- name: Remove google-chrome from 1Password allowed browsers when absent
  ansible.builtin.lineinfile:
    path: /etc/1password/custom_allowed_browsers
    line: google-chrome
    state: absent
  become: true
  when: app_states['chrome'] | default('present') == 'absent'
  failed_when: false

- name: Remove google-chrome-stable from 1Password allowed browsers when absent
  ansible.builtin.lineinfile:
    path: /etc/1password/custom_allowed_browsers
    line: google-chrome-stable
    state: absent
  become: true
  when: app_states['chrome'] | default('present') == 'absent'
  failed_when: false

# General purpose fish functions and aliases
# Managed by Ansible - changes may be overwritten
# File: ~/.config/fish/conf.d/general-functions.fish

# tmpcd - Create temporary directory and cd into it
# Usage: tmpcd [prefix]
# Example: tmpcd work    # Creates /tmp/tmp.XXXXXX with "work" prefix
function tmpcd --description "Create temporary directory and cd into it"
    if test (count $argv) -eq 0
        set tmp_dir (mktemp -d)
    else
        set tmp_dir (mktemp -d -t "$argv[1].XXXXXX")
    end

    if test -d "$tmp_dir"
        cd "$tmp_dir"
        echo "Created and moved to: $tmp_dir"
    else
        echo "Failed to create temporary directory" >&2
        return 1
    end
end

# Additional general aliases can be added below
# These are global and available in all fish sessions

# Quick navigation shortcuts
alias goa='cd ~/dev/iac/desktoperator'

# gow - Go to Worktree using fzf
# Interactive two-level navigation to worktrees
function gow --description "Navigate to worktrees using fzf"
    set -l worktree_base "$HOME/dev/worktrees"

    # Check if worktree base directory exists
    if not test -d "$worktree_base"
        echo "Error: Worktree directory does not exist: $worktree_base"
        return 1
    end

    # Get list of repository directories
    set -l repos (find "$worktree_base" -mindepth 1 -maxdepth 1 -type d 2>/dev/null)

    if test -z "$repos"
        echo "No worktrees found in $worktree_base"
        return 1
    end

    # First level: Select repository
    set -l selected_repo (printf '%s\n' $repos | sed "s|$worktree_base/||" | fzf --prompt="Select repository > " --height=40% --reverse)

    if test -z "$selected_repo"
        # User cancelled selection
        return 0
    end

    set -l repo_path "$worktree_base/$selected_repo"

    # Get list of worktree directories in the selected repository
    set -l worktrees (find "$repo_path" -mindepth 1 -maxdepth 1 -type d 2>/dev/null)

    if test -z "$worktrees"
        echo "No worktrees found in $selected_repo"
        return 1
    end

    # Second level: Select worktree
    set -l selected_worktree (printf '%s\n' $worktrees | sed "s|$repo_path/||" | fzf --prompt="Select worktree ($selected_repo) > " --height=40% --reverse)

    if test -z "$selected_worktree"
        # User cancelled selection
        return 0
    end

    set -l target_path "$repo_path/$selected_worktree"

    # Change to the selected directory
    cd "$target_path"
    echo "Changed to: $target_path"
end

# mdopen - Pick a Documents subdirectory and open it in Typora (gum drill-down or gum filter, fzf fallback)
function mdopen --description "Open Typora in a selected Documents subdirectory"
    set -l base "$HOME/Documents"
    set -l mode "drill"  # drill (gum choose) or fuzzy (gum filter)

    if test (count $argv) -gt 0
        if test "$argv[1]" = "--fuzzy"
            set mode "fuzzy"
            if test (count $argv) -gt 1
                set base "$argv[2]"
            end
        else
            set base "$argv[1]"
        end
    end

    if not type -q typora
        echo "Error: typora is not installed or not on PATH" >&2
        return 1
    end

    if not test -d "$base"
        echo "Error: Base directory does not exist: $base" >&2
        return 1
    end

    # Gum drill-down selector (preferred)
    if test "$mode" = "drill" -a (type -q gum)
        set -l current "$base"
        while true
            set -l entries (find "$current" -maxdepth 1 -mindepth 1 -type d -printf '%f\n' 2>/dev/null | sort)
            set -l options "." "Open current" $entries
            if test "$current" != "$base"
                set options ".." $options
            end

            set -l choice (printf '%s\n' $options | gum choose --header "mdopen · Current: $current" --cursor "› " --height 12 --limit 1)

            if test -z "$choice"
                return 0  # cancelled
            end

            switch "$choice"
                case "Open current" "."
                    typora "$current"
                    return $status
                case ".."
                    set current (dirname "$current")
                case "*"
                    set current "$current/$choice"
            end
        end
    end

    # Gum fuzzy filter (flat)
    if test "$mode" = "fuzzy" -a (type -q gum)
        set -l selection (find "$base" -type d -printf '%P\n' 2>/dev/null | sed 's/^$/./' | gum filter --header "mdopen · fuzzy · $base" --prompt "› " --height 15)
        if test -z "$selection"
            return 0
        end
        set -l target "$base"
        if test "$selection" != "."
            set target "$base/$selection"
        end
        if not test -d "$target"
            echo "Error: Selected path is not a directory: $target" >&2
            return 1
        end
        typora "$target"
        return $status
    end

    # fzf fallback: fuzzy-pick any descendant directory
    if not type -q fzf
        echo "Error: No selection UI available (gum or fzf) for mdopen" >&2
        return 1
    end

    set -l selection (find "$base" -type d -printf '%P\n' 2>/dev/null | sed 's/^$/./' | fzf --prompt="Typora directory > " --header="Type to filter; Enter opens in Typora" --height=70% --reverse --preview "ls -a \"$base/{}\"" --preview-window=down:10:wrap)

    if test -z "$selection"
        return 0
    end

    set -l target "$base"
    if test "$selection" != "."
        set target "$base/$selection"
    end

    if not test -d "$target"
        echo "Error: Selected path is not a directory: $target" >&2
        return 1
    end

    typora "$target"
end

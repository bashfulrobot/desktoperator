---
# Docker installation tasks for Ubuntu 24.04

# Installation tasks (when state is present)
- name: Remove conflicting Docker packages
  ansible.builtin.apt:
    name: "{{ docker_conflicting_packages }}"
    state: absent
    purge: true
  become: true
  when: docker_state == 'present'

- name: Add Docker repository with GPG key
  ansible.builtin.deb822_repository:
    name: docker
    types: [deb]
    uris: https://download.docker.com/linux/ubuntu
    suites: "{{ ansible_distribution_release }}"
    components: [stable]
    architectures: "{{ docker_arch_mapping[ansible_architecture] | default(ansible_architecture) }}"
    signed_by: "{{ docker_gpg_key_url }}"
    state: "{{ docker_state }}"
  become: true

- name: Update APT cache after repository changes
  ansible.builtin.apt:
    update_cache: true
  become: true

- name: Install Docker packages
  ansible.builtin.apt:
    name: "{{ docker_packages }}"
    state: "{{ docker_state }}"
    purge: "{{ docker_state == 'absent' }}"
  become: true

- name: Ensure Docker service is enabled and started
  ansible.builtin.systemd:
    name: docker
    enabled: "{{ docker_state == 'present' }}"
    state: "{{ 'started' if docker_state == 'present' else 'stopped' }}"
  become: true
  failed_when: false

- name: Manage user docker group membership
  ansible.builtin.user:
    name: "{{ user.name }}"
    groups: docker
    append: "{{ docker_state == 'present' }}"
  become: true
  when: docker_add_user_to_group | bool
  failed_when: false

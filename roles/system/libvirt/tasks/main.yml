---
# Libvirt installation tasks for Ubuntu 24.04

# Pre-flight checks
- name: Install cpu-checker for hardware verification
  ansible.builtin.apt:
    name: cpu-checker
    state: present
    update_cache: true
  become: true
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

- name: Check hardware virtualization support
  ansible.builtin.command:
    cmd: kvm-ok
  register: kvm_check
  failed_when: false
  changed_when: false
  become: true
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

- name: Display hardware virtualization status
  ansible.builtin.debug:
    msg: |
      ================================================================================
      HARDWARE VIRTUALIZATION CHECK
      ================================================================================
      {{ kvm_check.stdout }}
      {% if kvm_check.rc != 0 %}

      WARNING: KVM acceleration may not be available!

      Possible solutions:
      - Enable virtualization in BIOS/UEFI (look for Intel VT-x or AMD-V)
      - If running in a VM, enable nested virtualization
      - Check: grep -E 'vmx|svm' /proc/cpuinfo

      Installation will continue, but VMs will run slowly without KVM acceleration.
      ================================================================================
      {% else %}

      KVM acceleration is available and ready to use!
      ================================================================================
      {% endif %}
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

# Installation tasks (when state is present)
- name: Enable IP forwarding for routed networks
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: '1'
    sysctl_set: true
    state: present
    reload: true
  become: true
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

- name: Install libvirt packages
  ansible.builtin.apt:
    name: "{{ libvirt_packages }}"
    state: present
    update_cache: true
  become: true
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

- name: Load KVM kernel modules
  community.general.modprobe:
    name: "{{ item }}"
    state: present
    persistent: present
  become: true
  loop:
    - kvm
    - kvm_intel
    - kvm_amd
  failed_when: false
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

- name: Verify KVM kernel modules are loaded
  ansible.builtin.command:
    cmd: lsmod
  register: lsmod_output
  changed_when: false
  become: true
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

- name: Check which KVM modules loaded successfully
  ansible.builtin.set_fact:
    kvm_modules_loaded:
      kvm: "{{ 'kvm' in lsmod_output.stdout }}"
      kvm_intel: "{{ 'kvm_intel' in lsmod_output.stdout }}"
      kvm_amd: "{{ 'kvm_amd' in lsmod_output.stdout }}"
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

- name: Display KVM module status
  ansible.builtin.debug:
    msg: |
      ================================================================================
      KVM KERNEL MODULES STATUS
      ================================================================================
      kvm (base):        {{ 'LOADED ✓' if kvm_modules_loaded.kvm else 'NOT LOADED ✗' }}
      kvm_intel (Intel): {{ 'LOADED ✓' if kvm_modules_loaded.kvm_intel else 'NOT LOADED ✗' }}
      kvm_amd (AMD):     {{ 'LOADED ✓' if kvm_modules_loaded.kvm_amd else 'NOT LOADED ✗' }}

      {% if not kvm_modules_loaded.kvm %}
      WARNING: Base KVM module failed to load. Virtualization will not work.
      {% elif not kvm_modules_loaded.kvm_intel and not kvm_modules_loaded.kvm_amd %}
      WARNING: Neither Intel nor AMD KVM module loaded. Check CPU support.
      {% endif %}
      ================================================================================
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

- name: Configure udev rule for KVM device permissions
  ansible.builtin.copy:
    dest: /etc/udev/rules.d/99-kvm.rules
    content: |
      KERNEL=="kvm", GROUP="kvm", MODE="0660"
    mode: '0644'
  become: true
  notify: reload udev rules
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

- name: Verify KVM device exists
  ansible.builtin.stat:
    path: /dev/kvm
  register: kvm_device
  become: true
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

- name: Fix KVM device permissions if incorrect
  ansible.builtin.file:
    path: /dev/kvm
    owner: root
    group: kvm
    mode: '0660'
  become: true
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - kvm_device.stat.exists

- name: Display KVM availability warning
  ansible.builtin.debug:
    msg: |
      WARNING: /dev/kvm not found. Hardware virtualization may not be available.
      Possible causes:
      - Virtualization not enabled in BIOS/UEFI
      - Running inside a VM without nested virtualization
      - KVM modules failed to load
      Check: grep -E 'vmx|svm' /proc/cpuinfo
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - not kvm_device.stat.exists

- name: Install GUI tools for libvirt
  ansible.builtin.apt:
    name: "{{ libvirt_gui_packages }}"
    state: present
  become: true
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - libvirt_install_gui_tools | bool

- name: Configure QEMU permissions and security
  ansible.builtin.template:
    src: qemu.conf.j2
    dest: /etc/libvirt/qemu.conf
    owner: root
    group: root
    mode: '0600'
    backup: true
  become: true
  notify: restart libvirtd
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

- name: Ensure AppArmor local abstractions directory exists
  ansible.builtin.file:
    path: /etc/apparmor.d/local/abstractions
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: true
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

- name: Configure AppArmor override for libvirt-qemu to allow access to images
  ansible.builtin.copy:
    dest: /etc/apparmor.d/local/abstractions/libvirt-qemu
    content: |
      # Site-specific additions and overrides for libvirt-qemu
      # Allow access to default storage pool
      /var/lib/libvirt/images/** rwk,
    owner: root
    group: root
    mode: '0644'
  become: true
  notify:
    - reload apparmor profiles
    - restart libvirtd
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

- name: Set ACL permissions on default storage pool
  ansible.posix.acl:
    path: "{{ libvirt_default_storage_pool }}"
    entity: "{{ libvirt_qemu_user }}"
    etype: user
    permissions: rwx
    state: present
    recursive: true
  become: true
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - libvirt_configure_acls | bool

- name: Set default ACL permissions on default storage pool for new files
  ansible.posix.acl:
    path: "{{ libvirt_default_storage_pool }}"
    entity: "{{ libvirt_qemu_user }}"
    etype: user
    permissions: rwx
    state: present
    default: true
  become: true
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - libvirt_configure_acls | bool

- name: Set default ACL permissions on default storage pool for group
  ansible.posix.acl:
    path: "{{ libvirt_default_storage_pool }}"
    entity: "{{ libvirt_qemu_group }}"
    etype: group
    permissions: rwx
    state: present
    default: true
  become: true
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - libvirt_configure_acls | bool

- name: Set ACL permissions on additional storage paths
  ansible.posix.acl:
    path: "{{ item }}"
    entity: "{{ libvirt_qemu_user }}"
    etype: user
    permissions: rwx
    state: present
    recursive: true
  become: true
  loop: "{{ libvirt_additional_storage_paths }}"
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - libvirt_configure_acls | bool
    - libvirt_additional_storage_paths | length > 0

- name: Ensure libvirtd service is enabled and started
  ansible.builtin.systemd:
    name: "{{ libvirt_service }}"
    enabled: true
    state: started
  become: true
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

- name: Ensure libvirt supporting services are enabled and started
  ansible.builtin.systemd:
    name: "{{ item }}"
    enabled: true
    state: started
  become: true
  loop:
    - virtlogd.socket
    - virtlockd.socket
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

- name: Configure libvirt images directory with proper permissions
  ansible.builtin.file:
    path: "{{ libvirt_default_storage_pool }}"
    state: directory
    owner: root
    group: "{{ libvirt_qemu_group }}"
    mode: '2770'
  become: true
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'present'

- name: Add user to libvirt-related groups
  ansible.builtin.user:
    name: "{{ user.name }}"
    groups: "{{ libvirt_user_groups }}"
    append: true
  become: true
  register: user_groups_changed
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - libvirt_add_user_to_group | bool

- name: Display group membership notice
  ansible.builtin.debug:
    msg: |
      ================================================================================
      USER GROUP MEMBERSHIP UPDATED
      ================================================================================
      User '{{ user.name }}' has been added to libvirt-related groups:
      {{ libvirt_user_groups | join(', ') }}

      IMPORTANT: For group changes to take effect, you must either:
      - Log out and log back in, OR
      - Run: newgrp libvirt

      Without this, you won't be able to manage VMs or access /dev/kvm.
      ================================================================================
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - libvirt_add_user_to_group | bool
    - user_groups_changed.changed | default(false)

- name: Disable default network autostart
  ansible.builtin.command:
    cmd: virsh net-autostart default --disable
  become: true
  failed_when: false
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - not libvirt_default_network_autostart | bool

- name: Create routed network XML configurations
  ansible.builtin.template:
    src: routed-network.xml.j2
    dest: "/tmp/{{ item.name }}.xml"
    mode: '0644'
  become: true
  loop: "{{ libvirt_routed_networks }}"
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - libvirt_routed_networks | length > 0

- name: Check if routed networks exist
  ansible.builtin.command:
    cmd: "virsh net-info {{ item.name }}"
  become: true
  register: routed_networks_exist
  failed_when: false
  changed_when: false
  loop: "{{ libvirt_routed_networks }}"
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - libvirt_routed_networks | length > 0

- name: Define routed networks
  ansible.builtin.command:
    cmd: "virsh net-define /tmp/{{ item.item.name }}.xml"
  become: true
  loop: "{{ routed_networks_exist.results }}"
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - libvirt_routed_networks | length > 0
    - item.rc != 0

- name: Start routed networks
  ansible.builtin.command:
    cmd: "virsh net-start {{ item.name }}"
  become: true
  failed_when: false
  loop: "{{ libvirt_routed_networks }}"
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - libvirt_routed_networks | length > 0

- name: Configure routed network autostart
  ansible.builtin.command:
    cmd: "virsh net-autostart {{ item.name }} {{ '--disable' if not item.autostart else '' }}"
  become: true
  loop: "{{ libvirt_routed_networks }}"
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - libvirt_routed_networks | length > 0

- name: Clean up temporary network XML files
  ansible.builtin.file:
    path: "/tmp/{{ item.name }}.xml"
    state: absent
  become: true
  loop: "{{ libvirt_routed_networks }}"
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - libvirt_routed_networks | length > 0

- name: Get host primary IP address
  ansible.builtin.set_fact:
    host_primary_ip: "{{ ansible_default_ipv4.address }}"
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - libvirt_routed_networks | length > 0

- name: Display routing information for upstream router configuration
  ansible.builtin.debug:
    msg: |
      ================================================================================
      LIBVIRT ROUTED NETWORK CONFIGURATION - {{ inventory_hostname | upper }}
      ================================================================================

      Host: {{ inventory_hostname }}
      Host IP: {{ host_primary_ip }}

      Add these static routes to your upstream router:

      {% for network in libvirt_routed_networks %}
      Network: {{ network.name }}
        Destination: {{ network.subnet }}
        Gateway: {{ host_primary_ip }}
        Description: Route to {{ inventory_hostname }} {{ network.name }}

      {% endfor %}
      ================================================================================
      EXAMPLE ROUTER CONFIGURATION (adjust syntax for your router):
      {% for network in libvirt_routed_networks %}
      ip route {{ network.subnet }} via {{ host_primary_ip }}
      {% endfor %}
      ================================================================================
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'present'
    - libvirt_routed_networks | length > 0

# Cleanup tasks (when state is absent)
- name: List all libvirt networks
  ansible.builtin.command:
    cmd: virsh net-list --all --name
  become: true
  register: all_libvirt_networks
  failed_when: false
  changed_when: false
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'absent'

- name: Destroy all non-default networks
  ansible.builtin.command:
    cmd: "virsh net-destroy {{ item }}"
  become: true
  failed_when: false
  loop: "{{ all_libvirt_networks.stdout_lines | default([]) }}"
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'absent'
    - item != 'default'
    - item != ''

- name: Undefine all non-default networks
  ansible.builtin.command:
    cmd: "virsh net-undefine {{ item }}"
  become: true
  failed_when: false
  loop: "{{ all_libvirt_networks.stdout_lines | default([]) }}"
  tags: [libvirt]
  when:
    - app_states['libvirt'] | default('present') == 'absent'
    - item != 'default'
    - item != ''

- name: Stop libvirt supporting services
  ansible.builtin.systemd:
    name: "{{ item }}"
    state: stopped
    enabled: false
  become: true
  failed_when: false
  loop:
    - virtlogd.socket
    - virtlockd.socket
    - virtlogd.service
    - virtlockd.service
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'absent'

- name: Stop libvirtd service
  ansible.builtin.systemd:
    name: "{{ libvirt_service }}"
    state: stopped
    enabled: false
  become: true
  failed_when: false
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'absent'

- name: Remove libvirt packages
  ansible.builtin.apt:
    name: "{{ libvirt_packages + libvirt_gui_packages }}"
    state: absent
    purge: true
  become: true
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'absent'

- name: Remove user from libvirt-related groups
  ansible.builtin.command:
    cmd: "gpasswd -d {{ user.name }} {{ item }}"
  become: true
  failed_when: false
  loop: "{{ libvirt_user_groups }}"
  tags: [libvirt]
  when: app_states['libvirt'] | default('present') == 'absent'

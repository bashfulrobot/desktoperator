---
# Handlers for libvirt role

- name: Reload udev rules
  ansible.builtin.command:
    cmd: udevadm control --reload-rules && udevadm trigger --subsystem-match=misc
  become: true

- name: Reload apparmor profiles
  ansible.builtin.command:
    cmd: apparmor_parser -r /etc/apparmor.d/usr.sbin.libvirtd
  become: true

- name: Restart libvirtd
  ansible.builtin.systemd:
    name: libvirtd
    state: restarted
  become: true

- name: Reload ufw
  ansible.builtin.shell:
    cmd: |
      # Flush NAT POSTROUTING to prevent UFW from appending duplicate rules
      iptables -t nat -F POSTROUTING
      ufw reload
      # Restart libvirtd to re-insert libvirt chains at top of FORWARD chain
      # This ensures LIBVIRT_FWI/FWO/FWX chains process VM traffic before UFW chains
      systemctl restart libvirtd
  become: true

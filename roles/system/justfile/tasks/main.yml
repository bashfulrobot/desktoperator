---
# Justfile system management installation

- name: Install just command runner from GitHub
  ansible.builtin.include_tasks: ../../system/tasks/includes/github_release.yml
  vars:
    org: casey
    repo: just
    binary_name: just
    filename_substring: x86_64-unknown-linux-musl.tar.gz

- name: Create just system config directory
  ansible.builtin.file:
    path: /usr/local/share/just
    state: directory
    mode: "0755"
  become: true

- name: Create just modules directory
  ansible.builtin.file:
    path: /usr/local/share/just/modules
    state: directory
    mode: "0755"
  become: true

- name: Deploy system justfile modules
  ansible.builtin.template:
    src: "{{ item }}"
    dest: "/usr/local/share/just/modules/{{ item | basename | regex_replace('\\.j2$', '') }}"
    mode: "0644"
  become: true
  loop:
    - modules/updates.just.j2
    - modules/maintenance.just.j2
    - modules/generators.just.j2
    - modules/info.just.j2
    - modules/dictation.just.j2
  tags: [always]

- name: Deploy main system justfile
  ansible.builtin.template:
    src: system.just.j2
    dest: "{{ justfile_system_path }}"
    mode: "0644"
  become: true
  tags: [always]

- name: Deploy development justfile
  ansible.builtin.template:
    src: dev.just.j2
    dest: "{{ justfile_dev_path }}"
    mode: "0644"
  become: true
  tags: [always]

- name: Create jsys wrapper command
  ansible.builtin.copy:
    content: |
      #!/usr/bin/env bash
      # jsys - System management command wrapper
      # Runs the system justfile from anywhere
      just --justfile {{ justfile_system_path }} "$@"
    dest: "/usr/local/bin/{{ justfile_wrapper_command }}"
    mode: "0755"
  become: true

- name: Create jdev wrapper command
  ansible.builtin.copy:
    content: |
      #!/usr/bin/env bash
      # jdev - Development workflow command wrapper
      # Runs development justfile
      just --justfile {{ justfile_dev_path }} "$@"
    dest: "/usr/local/bin/jdev"
    mode: "0755"
  become: true

- name: Verify just installation
  ansible.builtin.command: just --version
  register: just_version_output
  changed_when: false
  failed_when: just_version_output.rc != 0

# Install developer scripts
- name: Install git-commit-gum script
  ansible.builtin.copy:
    src: ../../../../scripts/git-commit-gum.sh
    dest: /usr/local/bin/git-commit-gum
    mode: "0755"
  become: true

# Fish shell completion for jsys
- name: Create fish completions directory
  ansible.builtin.file:
    path: "{{ user.home }}/.config/fish/completions"
    state: directory
    owner: "{{ user.name }}"
    mode: "0755"

- name: Create fish completion for jsys
  ansible.builtin.copy:
    content: |
      # jsys completion - wraps system justfile
      function __fish_jsys_complete_recipes
          printf "%s\n" (string split " " (jsys --summary 2>/dev/null))
      end

      # don't suggest files right off
      complete -c jsys -n "__fish_is_first_arg" --no-files

      # complete recipes
      complete -c jsys -a '(__fish_jsys_complete_recipes)'

      # common options
      complete -c jsys -l list -d 'List available recipes'
      complete -c jsys -l summary -d 'List recipe names'
      complete -c jsys -l help -d 'Print help information'
    dest: "{{ user.home }}/.config/fish/completions/jsys.fish"
    owner: "{{ user.name }}"
    mode: "0644"
  become: true
  tags: [always]

- name: Create fish completion for jdev
  ansible.builtin.copy:
    content: |
      # jdev completion - wraps development justfile
      function __fish_jdev_complete_recipes
          printf "%s\n" (string split " " (jdev --summary 2>/dev/null))
      end

      # don't suggest files right off
      complete -c jdev -n "__fish_is_first_arg" --no-files

      # complete recipes
      complete -c jdev -a '(__fish_jdev_complete_recipes)'

      # common options
      complete -c jdev -l list -d 'List available development recipes'
      complete -c jdev -l summary -d 'List recipe names'
      complete -c jdev -l help -d 'Print help information'
    dest: "{{ user.home }}/.config/fish/completions/jdev.fish"
    owner: "{{ user.name }}"
    mode: "0644"
  become: true
  tags: [always]

- name: Create fish conf.d directory for jsys aliases
  ansible.builtin.file:
    path: "{{ user.home }}/.config/fish/conf.d"
    state: directory
    owner: "{{ user.name }}"
    mode: "0755"
  become: true
  tags: [always]

- name: Deploy jsys fish aliases
  ansible.builtin.copy:
    content: |
      # jsys command aliases with completions
      # Managed by Ansible - changes may be overwritten
      alias ual='jsys update-all'
      alias uan='jsys update-ansible'
      alias uat='jsys update-ansible-tags'
      alias uast='jsys update-ansible-skip-tags'

      # Completions for aliases
      complete -c ual -d 'Update everything (all package managers + Ansible)'
      complete -c uan -d 'Run full Ansible playbook'
      complete -c uat -d 'Run Ansible with specific tags'
      complete -c uast -d 'Run Ansible skipping specific tags'
    dest: "{{ user.home }}/.config/fish/conf.d/jsys-aliases.fish"
    owner: "{{ user.name }}"
    mode: "0644"
  become: true
  tags: [always]

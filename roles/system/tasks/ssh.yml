---
# SSH configuration tasks

- name: Deploy SSH private keys
  ansible.builtin.copy:
    content: "{{ item.value }}"
    dest: "{{ user.home }}/.ssh/{{ item.key }}"
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: '0600'
  loop: "{{ ssh_private_keys | dict2items }}"
  when: ssh_private_keys is defined
  no_log: true
  become: true

- name: Deploy SSH public keys
  ansible.builtin.copy:
    content: "{{ item.value }}"
    dest: "{{ user.home }}/.ssh/{{ item.key }}.pub"
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: '0644'
  loop: "{{ ssh_public_keys | dict2items }}"
  when: ssh_public_keys is defined
  become: true

- name: Deploy SSH config
  ansible.builtin.template:
    src: ssh_config.j2
    dest: "{{ user.home }}/.ssh/config"
    owner: "{{ user.name }}"
    group: "{{ user.name }}"
    mode: '0600'
  when: ssh_config is defined
  become: true

- name: Ensure SSH service is running
  ansible.builtin.service:
    name: ssh
    state: started
    enabled: true
  become: true

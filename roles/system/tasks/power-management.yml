---
# Power management configuration for scheduled wake-ups

- name: Deploy rtc-sleep-wake script
  ansible.builtin.copy:
    src: rtc-sleep-wake
    dest: /usr/local/bin/rtc-sleep-wake
    owner: root
    group: root
    mode: "0755"
  become: true
  tags: [system, power, scripts]

- name: Deploy morning wake systemd service
  ansible.builtin.template:
    src: morning-wake.service.j2
    dest: /etc/systemd/system/morning-wake.service
    owner: root
    group: root
    mode: "0644"
  become: true
  when:
    - morning_wake_enabled | default(false)
    - inventory_hostname == 'qbert'
  notify: Reload systemd daemon
  tags: [system]

- name: Deploy morning wake systemd timer
  ansible.builtin.template:
    src: morning-wake.timer.j2
    dest: /etc/systemd/system/morning-wake.timer
    owner: root
    group: root
    mode: "0644"
  become: true
  when:
    - morning_wake_enabled | default(false)
    - inventory_hostname == 'qbert'
  notify: Reload systemd daemon
  tags: [system]

- name: Enable and start morning wake timer
  ansible.builtin.systemd:
    name: morning-wake.timer
    enabled: true
    state: started
    daemon_reload: true
  become: true
  when:
    - morning_wake_enabled | default(false)
    - inventory_hostname == 'qbert'
  tags: [system]

- name: Stop and disable morning wake timer when disabled
  ansible.builtin.systemd:
    name: morning-wake.timer
    enabled: false
    state: stopped
  become: true
  when:
    - not (morning_wake_enabled | default(false))
    - inventory_hostname == 'qbert'
  failed_when: false
  tags: [system]

- name: Remove morning wake systemd units when disabled
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  become: true
  loop:
    - /etc/systemd/system/morning-wake.service
    - /etc/systemd/system/morning-wake.timer
  when:
    - not (morning_wake_enabled | default(false))
    - inventory_hostname == 'qbert'

  tags: [system]

---
# Ansible tooling management
# Ansible core is installed via bootstrap script (ppa:ansible/ansible)
# This role manages ansible-lint which requires pipx for compatibility

- name: Ensure pipx is installed
  ansible.builtin.apt:
    name: pipx
    state: present
  become: true
  tags: [ansible, dev]

- name: Ensure pipx PATH is configured for user
  ansible.builtin.command: pipx ensurepath
  become: true
  become_user: "{{ user.name }}"
  changed_when: false
  tags: [ansible, dev]

- name: Check if ansible-lint is already installed via pipx
  ansible.builtin.command: pipx list
  become: true
  become_user: "{{ user.name }}"
  register: pipx_list
  changed_when: false
  failed_when: false
  tags: [ansible, dev]

- name: Install ansible-lint via pipx
  ansible.builtin.command: pipx install ansible-lint
  become: true
  become_user: "{{ user.name }}"
  when: "'ansible-lint' not in pipx_list.stdout"
  tags: [ansible, dev]

- name: Upgrade ansible-lint via pipx
  ansible.builtin.command: pipx upgrade ansible-lint
  become: true
  become_user: "{{ user.name }}"
  when: "'ansible-lint' in pipx_list.stdout"
  register: pipx_upgrade
  changed_when: "'upgraded package' in pipx_upgrade.stdout"
  failed_when: false
  tags: [ansible, dev]

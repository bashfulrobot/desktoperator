# Kubernetes kubectl fish functions
# Managed by Ansible - changes may be overwritten
# File: ~/.config/fish/conf.d/kubectl-functions.fish

# k - kubectl alias
alias k='kubectl'

# kns - Select and switch to kubernetes namespace (requires fzf)
function kns --description "Select and switch kubernetes namespace with fzf"
    if not type -q fzf
        echo "Error: fzf is not installed" >&2
        return 1
    end

    if not type -q kubectl
        echo "Error: kubectl is not installed" >&2
        return 1
    end

    # Get current namespace
    set current_ns (kubectl config view --minify --output 'jsonpath={..namespace}' 2>/dev/null)
    if test -z "$current_ns"
        set current_ns "default"
    end

    # List namespaces and select with fzf
    set selected_ns (kubectl get namespaces -o jsonpath='{.items[*].metadata.name}' | tr ' ' '\n' | fzf --height=40% --reverse --header="Current: $current_ns" --preview='kubectl get pods -n {} 2>/dev/null | head -20')

    if test -n "$selected_ns"
        kubectl config set-context --current --namespace="$selected_ns"
        echo "✓ Switched to namespace: $selected_ns"
    else
        echo "No namespace selected"
    end
end

# kcfg - Select and copy kubeconfig file to active location (requires fzf)
function kcfg --description "Select kubeconfig from ~/.kube/clusters/ and copy to ~/.kube/config"
    if not type -q fzf
        echo "Error: fzf is not installed" >&2
        return 1
    end

    set clusters_dir "$HOME/.kube/clusters"
    set active_config "$HOME/.kube/config"

    if not test -d "$clusters_dir"
        echo "Error: Directory $clusters_dir does not exist" >&2
        return 1
    end

    # Determine current config if it exists
    set current_config "none"
    if test -f "$active_config"
        set current_context (kubectl config current-context 2>/dev/null)
        if test -n "$current_context"
            set current_config "$current_context"
        end
    end

    # List kubeconfig files and select with fzf
    set selected_config (find "$clusters_dir" -maxdepth 1 -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*config*" \) -printf "%f\n" | fzf --height=40% --reverse --header="Current: $current_config" --preview="kubectl --kubeconfig=$clusters_dir/{} config get-contexts 2>/dev/null")

    if test -n "$selected_config"
        cp "$clusters_dir/$selected_config" "$active_config"
        echo "✓ Copied kubeconfig: $selected_config → ~/.kube/config"
        echo "  Contexts available:"
        kubectl config get-contexts
    else
        echo "No kubeconfig selected"
    end
end

# tcfg - Select and copy talosconfig file to active location (requires fzf)
function tcfg --description "Select talosconfig from ~/.talos/clusters/ and copy to ~/.talos/config"
    if not type -q fzf
        echo "Error: fzf is not installed" >&2
        return 1
    end

    set clusters_dir "$HOME/.talos/clusters"
    set active_config "$HOME/.talos/config"

    if not test -d "$clusters_dir"
        echo "Error: Directory $clusters_dir does not exist" >&2
        return 1
    end

    # Determine current config if it exists
    set current_config "none"
    if test -f "$active_config"
        set current_context (talosctl config info 2>/dev/null | grep -oP 'context:\s+\K\S+')
        if test -n "$current_context"
            set current_config "$current_context"
        end
    end

    # List talosconfig files and select with fzf
    set selected_config (find "$clusters_dir" -maxdepth 1 -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*config*" \) -printf "%f\n" | fzf --height=40% --reverse --header="Current: $current_config" --preview="talosctl --talosconfig=$clusters_dir/{} config info 2>/dev/null")

    if test -n "$selected_config"
        cp "$clusters_dir/$selected_config" "$active_config"
        echo "✓ Copied talosconfig: $selected_config → ~/.talos/config"
        echo "  Config info:"
        talosctl config info
    else
        echo "No talosconfig selected"
    end
end

# kctx - Quick context switcher (bonus: switch context within current kubeconfig)
function kctx --description "Select and switch kubernetes context with fzf"
    if not type -q fzf
        echo "Error: fzf is not installed" >&2
        return 1
    end

    if not type -q kubectl
        echo "Error: kubectl is not installed" >&2
        return 1
    end

    # Get current context
    set current_ctx (kubectl config current-context 2>/dev/null)

    # List contexts and select with fzf
    set selected_ctx (kubectl config get-contexts -o name | fzf --height=40% --reverse --header="Current: $current_ctx")

    if test -n "$selected_ctx"
        kubectl config use-context "$selected_ctx"
        echo "✓ Switched to context: $selected_ctx"
    else
        echo "No context selected"
    end
end

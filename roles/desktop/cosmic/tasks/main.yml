---
# COSMIC Desktop configuration management

- name: Ensure COSMIC config directory exists
  file:
    path: "{{ cosmic_config_path }}"
    state: directory
    owner: "{{ user.name }}"
    mode: '0755'

- name: Backup existing COSMIC config
  command: cp -r {{ cosmic_config_path }} {{ cosmic_backup_dir }}
  args:
    creates: "{{ cosmic_backup_dir }}"
  when: cosmic_backup_existing | default(true)
  failed_when: false

- name: Sync COSMIC configurations from repository
  synchronize:
    src: "{{ playbook_dir }}/cosmic-config/"
    dest: "{{ cosmic_config_path }}/"
    delete: yes
    rsync_opts:
      - "--chown={{ user.name }}:{{ user.name }}"
      - "--chmod=D0755,F0644"
      - "--exclude=com.system76.CosmicTheme.Mode/v1/is_dark"
      - "--exclude=com.system76.CosmicTheme.Mode/v1/is_light"
  delegate_to: "{{ inventory_hostname }}"

- name: Install COSMIC Tweaks from Flathub
  community.general.flatpak:
    name: dev.edfloreshz.CosmicTweaks
    state: present
    remote: flathub
  become: yes

- name: Remove COSMIC Tweaks when absent
  community.general.flatpak:
    name: dev.edfloreshz.CosmicTweaks
    state: absent
  become: yes
  when: false
